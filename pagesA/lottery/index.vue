<template>
<view>
	<block v-if="isload">
		<view class="container" :style="{backgroundColor:set.bgcolor}">
		<view class="banner">
			<view class="swiper">
				<image :src="set.banner" mode="widthFix" background-size="cover"></image>
			</view>
			<view class="datalist">
				<block v-for="(item, index) in datalist" :key="index">
				<view :data-url="'product?id=' + item.pro_id" @tap="goto" class="collage-product">
					<view class="product-pic">
						<text class="mark">第{{item.cycles}}轮</text>
						<image :src="item.pic" mode="widthFix"></image>
					</view> 
					<view class="product-info">
						<view class="p1">{{item.name}}</view>
						<view class="p2" style="padding-top: 20rpx;">
							<progress :percent="item.percent" stroke-width="6" border-radius="10" activeColor="#fb743b" />
						</view>
						<view class="p2">
							<view class="p2-1">
								总需{{item.score_total}}{{item.wallet_name}}，还剩余
								<text class="t1" :style="{color:t('color1')}">{{item.remain}}</text>
								{{item.wallet_name}}
							</view>
						</view>
						<view class="p3">
							<view class="t1">市场价￥<text style="font-size:32rpx;color:#f40;padding:0 2rpx;">{{item.market_price}}</text></view>
							<view v-if="item.can_join==1" class="t2" :style="{borderColor:t('color1'),color:t('color1')}" @tap="buydialogShow(item.id)">
								<text class="x2" :style="{backgroundColor:t('color1')}">去参与</text>
							</view>
							<view v-if="item.can_join==0" class="t2" :style="{borderColor:'gray',color:t('color1')}">
								<text class="x2" style="background:gray">去参与</text>
							</view>
						</view>
					</view>
				</view>
				</block>
			</view>
			<nomore v-if="nomore"></nomore>
			<nodata v-if="nodata"></nodata>
		</view>
		<button class="coverguize"  @tap="changemaskrule">活动规则</button>
		<button class="coverrecord" @tap="goto" data-url="myprize">开奖记录</button>
		<button class="covermy">我的{{t('积分')}}{{member.score}}</button>
		<button v-if="product_givetongzheng==1" class="covermy2">我的{{t('通证')}}{{member.tongzheng}}</button>
		
		<view id="mask-rule" v-if="showmaskrule">
			<view class="box-rule">
				<view class="h2">活动规则说明</view>
				<view id="close-rule" @tap="changemaskrule"
					:style="'background-image:url('+pre_url+'/static/img/dzp/close.png);background-size:100%'">
				</view>
				<view class="con">
					<view class="text">
						<text decode="true" space="true">{{set.guize}}</text>
				</view>
					</view>
			</view>
		</view>
		<view :hidden="buydialogHidden">
			<view class="buydialog-mask">
				<view class="buydialog" :class="menuindex>-1?'tabbarbot':'notabbarbot'">
					<view class="close" @tap="buydialogChange">
						<image :src="pre_url+'/static/img/close.png'" class="image"></image>
					</view>
					<view class="title">
						<image :src="detail.pic" class="img" @tap="previewImage" :data-url="detail.pic"></image>
						<view class="price">消耗{{select_wallet}}<text class="t1">￥</text>{{pay_score}}</view>
						<view class="stock">每注<text class="t1" style="color: red;">￥{{detail.usescore}}</text>{{select_wallet}}</view>
						<view class="choosename">{{detail.name}}</view>
						<view class="stock">最高可投{{detail.join_max_num}}注</view>
					</view>
					<view class="buynum flex flex-y-center">
						<view class="flex1">投注数量：</view>
						<view class="addnum">
							<view class="minus" @tap="gwcminus"><image class="img" :src="pre_url+'/static/img/cart-minus.png'" /></view>
							<input class="input" type="number" :value="gwcnum" @input="gwcinput"></input>
							<view class="plus" @tap="gwcplus"><image class="img" :src="pre_url+'/static/img/cart-plus.png'" /></view>
						</view>
					</view>
					<view class="op">
						<button class="tobuy" :style="{background:t('color2')}" @tap="tobuy" data-type="1">确定</button>
					</view>
				</view>
			</view>
		</view>
		</view>
	</block>
	<loading v-if="loading"></loading>
	<dp-tabbar :opt="opt"></dp-tabbar>
	<popmsg ref="popmsg"></popmsg>
</view>
</template>

<script>
var app = getApp();
export default {
  data() {
    return {
		opt:{},
		loading:false,
		isload: false,
		menuindex:-1,
		pre_url:app.globalData.pre_url,
			
		bid:'',
		pics: [],
		pagenum: 1,
		st: '',
		datalist: [],
		nomore: false,
		nodata:false,
		set:{},
		member:{},
		showmaskrule:false,
		buydialogHidden: true,
		detail:{},
		gwcnum:1,
		pay_score:0,
		product_givetongzheng:0,
		select_wallet:''
    };
  },
  onLoad: function (opt) {
		this.opt = app.getopts(opt);
		this.bid = this.opt.bid || '';
		this.getdata();
  },
	onPullDownRefresh: function () {
		this.getdata();
	},
  onReachBottom: function () {
    if (!this.nodata && !this.nomore) {
      this.pagenum = this.pagenum + 1;
      this.getdata(true);
    }
  },
  methods: {
		getdata: function (loadmore) {
			var that = this;
			if(!loadmore){
				this.pagenum = 1;
				this.datalist = [];
			}
			var pagenum = that.pagenum;
			var st = that.st;
			that.loading = true;
			that.nodata = false;
			that.nomore = false;
			app.post('ApiChoujiangManren/index', {pagenum: pagenum}, function (res) {
				that.loading = false;
				var data = res.datalist;
				if (pagenum == 1) {
					that.datalist = data;
					if (data.length == 0) {
						that.nodata = true;
					}
					that.set = res.set;
					that.member = res.member;
					that.product_givetongzheng = res.product_givetongzheng;
				}else{
					if (data.length == 0) {
						that.nomore = true;
					} else {
						var datalist = that.datalist;
						var newdata = datalist.concat(data);
						that.datalist = newdata;
					}
				}
				that.loaded();
			});
		},
		changetab: function (e) {
		  var st = e.currentTarget.dataset.st;
		  this.pagenum = 1;
				this.st = st;
		  this.datalist = [];
		  uni.pageScrollTo({
			scrollTop: 0,
			duration: 0
		  });
		  this.getdata();
		},
		changemaskrule: function() {
			this.showmaskrule = !this.showmaskrule;
		},
		buydialogShow: function (id) {
			console.log('参与id',id);
			var that = this;
			app.post('ApiChoujiangManren/getinfo', {id: id}, function (res) {
				var detail = res.info;
				if(detail.can_join==0){
					app.error('暂不可参与');
					return;
				}
				that.detail = res.info;
				that.buydialogHidden = !that.buydialogHidden;
				that.gwcnum = 1;
				that.pay_score = res.info.usescore;
				that.select_wallet = res.info.wallet_name;
				that.loaded();
			});
		},
		buydialogChange: function (e) {
			this.buydialogHidden = !this.buydialogHidden;
		},
		gwcplus: function (e) {
			var detail = this.detail;
			var gwcnum = this.gwcnum + 1;
			if (gwcnum > detail.remaintimes) {
				app.error('可参与次数不足');
				return;
			}
			this.gwcnum = this.gwcnum + 1;
			this.pay_score = this.gwcnum*detail.usescore;
		},
		//减
		gwcminus: function (e) {
			var detail = this.detail;
			console.log(this.gwcnum);
			var gwcnum = this.gwcnum - 1;
			console.log(gwcnum);
			if (gwcnum <= 1) {
				gwcnum = 1;
			}
			this.gwcnum = gwcnum
			this.pay_score = gwcnum*detail.usescore;
		},
		//输入
		gwcinput: function (e) {
			var detail = this.detail;
			var gwcnum = parseInt(e.detail.value);
			if (gwcnum < 1) {
				gwcnum = 1;
			};
		
			if (gwcnum > detail.remaintimes) {
				gwcnum = detail.remaintimes;
			}
			this.gwcnum = gwcnum;
			this.pay_score = gwcnum*detail.usescore;
		},
		tobuy:function(id){
			var that = this;
			that.buydialogHidden = true;
			app.showLoading('提交中');
			app.post('ApiChoujiangManren/join', {id: that.detail.id,num:that.gwcnum}, function (res) {
				if(res.can_join==0){
					app.error('暂不可参与');
					return;
				}else{
					if(res.status==1){
						app.success(res.msg);
					}else{
						app.error(res.msg);
					}
					that.getdata();
				}
				
			});
		}
	}
}
</script>
<style>
	
/* .banner{position: absolute;width: 100%;padding-bottom: 40rpx;} */
.swiper {margin-top: 20rpx;border-radius:20rpx;overflow:hidden}
.swiper image {width: 100%;height: 350rpx;overflow: hidden;}

.category{width:94%;margin:0 3%;padding-top: 10px;padding-bottom: 10px;flex-direction:row;white-space: nowrap; display:flex;}
.category .item{width: 150rpx;display: inline-block; text-align: center;}
.category .item image{width: 80rpx;height: 80rpx;margin: 0 auto;border-radius: 50%;}
.category .item .t1{display: block;color: #666;}

.datalist{width:94%;margin:0 3%;height: 100%;}
.collage-product {display:flex;height:220rpx; background: #fff; padding:20rpx 20rpx;margin-top: 20rpx;border-radius:20rpx;}
.collage-product .product-pic {width: 180rpx;height: 180rpx; background: #ffffff;overflow:hidden;position: relative;}
.collage-product .product-pic image{width: 100%;height:180rpx;}
.collage-product .product-info {padding: 5rpx 10rpx;flex:1}
.collage-product .product-info .p1 {color:#323232;font-weight:bold;font-size:32rpx;line-height:36rpx;height:36rpx;margin-bottom:10rpx;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;}
.collage-product .product-info .p2{font-size: 24rpx;height:40rpx;line-height: 40rpx;color:#aaa;}
.collage-product .product-info .p2 .t1{color: #f40;}
.collage-product .product-info .p2 .t2 {margin-left: 10rpx;font-size: 26rpx;color: #888;text-decoration: line-through;}
.collage-product .product-info .p3{font-size: 24rpx;height:50rpx;line-height:50rpx;overflow:hidden;display:flex;}
.collage-product .product-info .p3 .t1{color:#aaa;font-size:24rpx;flex:1}
.collage-product .product-info .p3 .t2{height: 50rpx;line-height: 50rpx;overflow: hidden;border: 1px #FF3143 solid;border-radius:10rpx;}
.collage-product .product-info .p3 .t2 .x1{padding: 10rpx 24rpx;}
.collage-product .product-info .p3 .t2 .x2{padding: 14rpx 24rpx;background: #FF3143;color:#fff;}
.collage-product .mark{
	    position: absolute;
	    top: 0;
	    left: 0;
	    z-index: 2;
	    padding: 0.075rem 0.1rem;
	    color: #fff;
	    font-size: 26rpx;
	    font-weight: 700;
	    background-color: #ff7537;
	    border-radius: 0.1rem 0 0.25rem 0;
}
.coverguize{
	position:absolute;z-index:99999;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;
	z-index:9999;top:150rpx;right:0;color:#fff;background-color:rgba(17,17,17,0.3);font-size:26rpx;border-radius:30rpx 0px 0px 30rpx;
	width: 55rpx;
	padding: 0.3375rem 0.275rem;
	word-break: break-all;
	font-size: 26rpx;
	height: auto;
	line-height: 35rpx;
	}
.coverrecord{
	position:absolute;z-index:99999;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;z-index:9999;
	top:330rpx;right:0;color:#fff;background-color:rgba(17,17,17,0.3);font-size:26rpx;border-radius:30rpx 0px 0px 30rpx;
	width: 55rpx;
	padding: 0.3375rem 0.275rem;
	word-break: break-all;
	font-size: 26rpx;
	height: auto;
	line-height: 35rpx;
	}
.covermy{position:absolute;z-index:99999;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;
z-index:9999;top:520rpx;right:0;color:#fff;background-color:rgba(17,17,17,0.3);padding:0 10rpx 0 10rpx;height:60rpx;font-size:26rpx;border-radius:30rpx 0px 0px 30rpx;}
.covermy2{position:absolute;z-index:99999;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;
z-index:9999;top:600rpx;right:0;color:#fff;background-color:rgba(17,17,17,0.3);padding:0 10rpx 0 10rpx;height:60rpx;font-size:26rpx;border-radius:30rpx 0px 0px 30rpx;}

/*规则弹窗*/
	#mask-rule,
	#mask {
		position: fixed;
		left: 0;
		top: 0;
		z-index: 99999;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.85);
	}

	#mask-rule .box-rule {
		position: relative;
		margin: 30% auto;
		padding-top: 40rpx;
		width: 90%;
		height: 675rpx;
		border-radius: 20rpx;
		background-color: #f58d40;
	}

	#mask-rule .box-rule .star {
		position: absolute;
		left: 50%;
		top: -100rpx;
		margin-left: -130rpx;
		width: 259rpx;
		height: 87rpx;
	}

	#mask-rule .box-rule .h2 {
		width: 100%;
		text-align: center;
		line-height: 34rpx;
		font-size: 34rpx;
		font-weight: normal;
		color: #fff;
	}

	#mask-rule #close-rule {
		position: absolute;
		right: 34rpx;
		top: 38rpx;
		width: 40rpx;
		height: 40rpx;
	}

	/*内容盒子*/
	#mask-rule .con {
		overflow: auto;
		position: relative;
		margin: 40rpx auto;
		padding-right: 15rpx;
		width: 580rpx;
		height: 82%;
		line-height: 48rpx;
		font-size: 26rpx;
		color: #fff;
	}

	#mask-rule .con .text {
		position: absolute;
		top: 0;
		left: 0;
		width: inherit;
		height: auto;
	}
	
	.buydialog-mask{ position: fixed; top: 0px; left: 0px; width: 100%; background: rgba(0,0,0,0.5); bottom: 0px;z-index:1000000}
	.buydialog{ position: fixed; width: 100%; left: 0px; bottom: 0px; background: #fff;z-index:11;border-radius:20rpx 20rpx 0px 0px}
	.buydialog .close{ position: absolute; top: 0; right: 0;padding:20rpx;z-index:12}
	.buydialog .close .image{ width: 30rpx; height:30rpx; }
	.buydialog .title{ width: 94%;position: relative; margin: 0 3%; padding:20rpx 0px; border-bottom:0; height: 190rpx;}
	.buydialog .title .img{ width: 160rpx; height: 160rpx; position: absolute; top: 20rpx; border-radius: 10rpx; border: 0 #e5e5e5 solid;background-color: #fff}
	.buydialog .title .price{ padding-left:180rpx;width:100%;font-size: 36rpx;height:70rpx; color: #FC4343;overflow: hidden;}
	.buydialog .title .price .t1{ font-size:26rpx}
	.buydialog .title .price .t2{ font-size:26rpx;text-decoration:line-through;color:#aaa}
	.buydialog .title .choosename{ padding-left:180rpx;width: 100%;font-size: 24rpx;height: 42rpx;line-height:42rpx;color:#888888}
	.buydialog .title .stock{ padding-left:180rpx;width: 100%;font-size: 24rpx;height: 42rpx;line-height:42rpx;color:#888888}
	
	.buydialog .guigelist{ width: 94%; position: relative; margin: 0 3%; padding:0px 0px 10px 0px; border-bottom: 0; }
	.buydialog .guigelist .name{ height:70rpx; line-height: 70rpx;}
	.buydialog .guigelist .item{ font-size: 30rpx;color: #333;flex-wrap:wrap}
	.buydialog .guigelist .item2{ height:60rpx;line-height:60rpx;margin-bottom:4px;border:0; border-radius:4rpx; padding:0 40rpx;color:#666666; margin-right: 10rpx; font-size:26rpx;background:#F4F4F4}
	.buydialog .guigelist .on{color:#FC4343;background:rgba(252,67,67,0.1);font-weight:bold}
	.buydialog .buynum{ width: 94%; position: relative; margin: 0 3%; padding:10px 0px 10px 0px; }
	.buydialog .addnum {font-size: 30rpx;color: #666;width:auto;display:flex;align-items:center}
	.buydialog .addnum .plus {width:48rpx;height:36rpx;background:#F6F8F7;display:flex;align-items:center;justify-content:center}
	.buydialog .addnum .minus {width:48rpx;height:36rpx;background:#F6F8F7;display:flex;align-items:center;justify-content:center}
	.buydialog .addnum .img{width:24rpx;height:24rpx}
	.buydialog .addnum .input{flex:1;width:70rpx;border:0;text-align:center;color:#2B2B2B;font-size:24rpx}
	.buydialog .op{width:90%;margin:20rpx 5%;border-radius:36rpx;overflow:hidden;display:flex;margin-top:100rpx;}
	.buydialog .addcart{flex:1;height:72rpx; line-height: 72rpx;color: #fff; border-radius: 0px; border: none; font-size:28rpx;font-weight:bold}
	.buydialog .tobuy{flex:1;height: 72rpx; line-height: 72rpx;color: #fff; border-radius: 0px; border: none;}
	.buydialog .nostock{flex:1;height: 72rpx; line-height: 72rpx; background:#aaa; color: #fff; border-radius: 0px; border: none;}
	
</style>