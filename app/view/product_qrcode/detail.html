<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>二维码详情</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  {include file="public/css"/}
  <style>
    .qrcode-detail {
      display: flex;
      margin: 20px 0;
    }
    .qrcode-info {
      flex: 1;
    }
    .qrcode-preview {
      width: 300px;
      text-align: center;
    }
    .qrcode-preview img {
      max-width: 200px;
      max-height: 200px;
      border: 1px solid #eee;
    }
    .info-item {
      margin-bottom: 15px;
    }
    .info-label {
      display: inline-block;
      width: 100px;
      font-weight: bold;
      vertical-align: top;
    }
    .info-value {
      display: inline-block;
      width: 300px;
    }
    .stats-section {
      margin: 20px 0;
      padding: 15px;
      background-color: #f7f7f7;
      border-radius: 4px;
    }
    .stats-grid {
      display: flex;
      justify-content: space-around;
    }
    .stats-item {
      text-align: center;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
    }
    .stats-value {
      font-size: 24px;
      font-weight: bold;
      color: #1890ff;
    }
    .stats-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-card layui-col-md12">
        <div class="layui-card-header">
          二维码详情
          <div style="float: right;">
            <a href="{:url('ProductQrcode/index')}" class="layui-btn layui-btn-sm layui-btn-primary">返回列表</a>
            <a id="downloadBtn" class="layui-btn layui-btn-sm" href="{$qrcode.qrcode_url}" download>下载二维码</a>
            <a id="printBtn" class="layui-btn layui-btn-sm layui-btn-normal">打印二维码</a>
          </div>
        </div>
        <div class="layui-card-body" pad15>
          <!-- 二维码基本信息 -->
          <div class="qrcode-detail">
            <div class="qrcode-info">
              <div class="info-item">
                <span class="info-label">唯一码：</span>
                <span class="info-value"><code>{$qrcode.code}</code></span>
              </div>
              <div class="info-item">
                <span class="info-label">商品名称：</span>
                <span class="info-value">{$qrcode.product_info.name}</span>
              </div>
              <div class="info-item">
                <span class="info-label">商品ID：</span>
                <span class="info-value">{$qrcode.product_id}</span>
              </div>
              <div class="info-item">
                <span class="info-label">商品类型：</span>
                <span class="info-value">{$qrcode.product_type == 1 ? '普通商品' : '拼团商品'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">规格ID：</span>
                <span class="info-value">{$qrcode.specs_id ? $qrcode.specs_id : '无'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">客户姓名：</span>
                <span class="info-value">{$qrcode.customer_name ? $qrcode.customer_name : '无'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">客户电话：</span>
                <span class="info-value">{$qrcode.customer_phone ? $qrcode.customer_phone : '无'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">订单ID：</span>
                <span class="info-value">{$qrcode.order_id ? $qrcode.order_id : '无'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">状态：</span>
                <span class="info-value">
                  {if $qrcode.status == 1}
                  <span class="status-tag status-enabled">启用</span>
                  {elseif $qrcode.status == 2}
                  <span class="status-tag status-used">已使用</span>
                  {else}
                  <span class="status-tag status-disabled">禁用</span>
                  {/if}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">创建时间：</span>
                <span class="info-value">{$qrcode.create_time|date='Y-m-d H:i:s',###}</span>
              </div>
              <div class="info-item">
                <span class="info-label">备注：</span>
                <span class="info-value">{$qrcode.remark ? $qrcode.remark : '无'}</span>
              </div>
            </div>
            <div class="qrcode-preview">
              <h4>二维码预览</h4>
              <img src="{$qrcode.qrcode_url}" alt="二维码">
              <div style="margin-top: 10px;">
                <a href="{$qrcode.qrcode_url}" class="layui-btn layui-btn-sm" download>下载</a>
                <a href="javascript:;" class="layui-btn layui-btn-sm layui-btn-normal" onclick="printQrcode()">打印</a>
              </div>
            </div>
          </div>
          
          <!-- 扫码统计 -->
          <div class="stats-section">
            <h3>扫码统计</h3>
            <div class="stats-grid">
              <div class="stats-item">
                <div class="stats-value">{$scanStats.total|default=0}</div>
                <div class="stats-label">总扫码次数</div>
              </div>
              <div class="stats-item">
                <div class="stats-value">{$scanStats.today|default=0}</div>
                <div class="stats-label">今日扫码</div>
              </div>
              <div class="stats-item">
                <div class="stats-value">{$scanStats.yesterday|default=0}</div>
                <div class="stats-label">昨日扫码</div>
              </div>
            </div>
          </div>
          
          <!-- 扫码记录 -->
          <div class="scan-records">
            <h3>扫码记录</h3>
            <table class="layui-table" lay-data="{id:'scanTable', page:true, limit:10, limits:[10,20,50]}" lay-filter="scanTable">
              <thead>
                <tr>
                  <th lay-data="{field:'id', width:80}">ID</th>
                  <th lay-data="{field:'openid', width:200}">OpenID</th>
                  <th lay-data="{field:'ip', width:150}">IP地址</th>
                  <th lay-data="{field:'platform', width:100}">平台</th>
                  <th lay-data="{field:'scan_time', width:180, templet:'#timeTpl'}">扫码时间</th>
                </tr>
              </thead>
              <tbody>
                {volist name="scanList" id="scan"}
                <tr>
                  <td>{$scan.id}</td>
                  <td>{$scan.openid|default='-'}</td>
                  <td>{$scan.ip|default='-'}</td>
                  <td>{$scan.platform|default='-'}</td>
                  <td>{$scan.scan_time|date='Y-m-d H:i:s',###}</td>
                </tr>
                {/volist}
              </tbody>
            </table>
          </div>
          
          <!-- 服务记录 -->
          <div class="service-records">
            <h3>服务记录</h3>
            <table class="layui-table" lay-data="{id:'serviceTable', page:true, limit:10, limits:[10,20,50]}" lay-filter="serviceTable">
              <thead>
                <tr>
                  <th lay-data="{field:'id', width:80}">ID</th>
                  <th lay-data="{field:'operator_name', width:120}">操作人</th>
                  <th lay-data="{field:'operator_type_text', width:120}">身份</th>
                  <th lay-data="{field:'action_text', width:120}">操作类型</th>
                  <th lay-data="{field:'content', width:200}">操作内容</th>
                  <th lay-data="{field:'result_text', width:80}">结果</th>
                  <th lay-data="{field:'remark', width:200}">备注</th>
                  <th lay-data="{field:'create_time', width:180, templet:'#timeTpl'}">操作时间</th>
                </tr>
              </thead>
              <tbody>
                <!-- 服务记录将通过AJAX加载 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {include file="public/js"/}
  <script type="text/html" id="timeTpl">
    {{layui.util.toDateString(d.scan_time * 1000, 'yyyy-MM-dd HH:mm:ss')}}    
  </script>
  <script>
    layui.use(['table', 'layer'], function() {
      var table = layui.table;
      var layer = layui.layer;
      
      // 渲染表格
      table.render({
        elem: '#scanTable',
        url: '{:url("ApiQrcode/getScanRecords")}',
        where: {qrcode_id: {$qrcode.id}},
        page: true,
        limit: 10,
        limits: [10,20,50],
        text: {
          none: '暂无扫码记录'
        }
      });
      
      // 渲染服务记录表格
      table.render({
        elem: '#serviceTable',
        url: '{:url("ApiQrcode/getServiceLogs")}',
        where: {qrcode_id: {$qrcode.id}},
        page: true,
        limit: 10,
        limits: [10,20,50],
        text: {
          none: '暂无服务记录'
        },
        cols: [[
          {field:'id', width:80, title: 'ID'},
          {field:'operator_name', width:120, title: '操作人'},
          {field:'operator_type_text', width:120, title: '身份'},
          {field:'action_text', width:120, title: '操作类型'},
          {field:'content', width:200, title: '操作内容'},
          {field:'result_text', width:80, title: '结果'},
          {field:'remark', width:200, title: '备注'},
          {field:'create_time', width:180, title: '操作时间', templet:'#timeTpl'}
        ]]
      });
      
      // 打印二维码
      window.printQrcode = function() {
        layer.msg('打印功能开发中', {icon: 6});
      };
      
      // 打印按钮点击事件
      document.getElementById('printBtn').onclick = printQrcode;
    });
  </script>
</body>
</html>