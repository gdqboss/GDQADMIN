<!DOCTYPE html><!--custom_file(forcerebuy)-->
<html>
<head>
  <meta charset="utf-8">
  <title>强制复购设置</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  {include file="public/css"/}
</head>
<body>
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-card layui-col-md12">
                <div class="layui-card-header">
                    {if !$info['id']}<i class="fa fa-plus"></i> 添加强制复购{else}<i class="fa fa-pencil"></i> 编辑强制复购{/if}
                    <i class="layui-icon layui-icon-close" style="font-size:18px;font-weight:bold;cursor:pointer" onclick="closeself()"></i>
                </div>
                <div class="layui-card-body" pad15>
                    <div class="layui-form form-label-w8" lay-filter="">
                        <input type="hidden" name="info[id]" value="{$info['id']}">


                        <div class="layui-form-item">
                            <label class="layui-form-label">活动名称：</label>
                            <div class="layui-input-inline" style="width:300px">
                                <input type="text" name="info[name]" value="{$info.name}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">触发条件：</label>
                            <div class="layui-input-inline" >
                                <input type="radio" name="info[type]" value="0" {if $info['type']==0}checked{/if} title="佣金" lay-filter="typeset"/>
                                <input type="radio" name="info[type]" value="1" {if $info['type']==1}checked{/if} title="时间" lay-filter="typeset"/>
                            </div>
                        </div>
                        <div class="layui-form-item" {if $info['type']!=0}style="display:none"{/if} id="typeset0">
                            <label class="layui-form-label">佣金达：</label>
                            <div class="layui-input-inline" style="width:300px">
                                <input type="text" name="info[commission]" value="{$info.commission}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
					
                        <div class="layui-form-item" {if $info['type']!=1}style="display:none"{/if} id="typeset1">
                            <label class="layui-form-label">时间周期：</label>
                            <div class="layui-input-inline" style="width:300px">
                                <input type="radio" name="info[daytype]" value="0" {if $info['daytype']==0}checked{/if} title="每月" />
                                <input type="radio" name="info[daytype]" value="1" {if $info['daytype']==1}checked{/if} title="每季度" />
                                <input type="radio" name="info[daytype]" value="2" {if $info['daytype']==2}checked{/if} title="每年" />
                            </div>
                            <div class="layui-form-mid layui-word-aux"></div>
                        </div>


                        <div class="layui-form-item">
                            <label class="layui-form-label">复购商品 ：</label>
                            <div class="layui-input-inline" style="width:500px">
                                <input type="radio" name="info[fwtype]" value="0" {if $info['fwtype']==0}checked{/if} title="所有商品" lay-filter="fwtype"/>
                                <input type="radio" name="info[fwtype]" value="1" {if $info['fwtype']==1}checked{/if} title="指定类目" lay-filter="fwtype"/>
                                <input type="radio" name="info[fwtype]" value="2" {if $info['fwtype']==2}checked{/if} title="指定商品" lay-filter="fwtype"/>
                            </div>
                            <div class="fwtype1" style="clear:both;{if $info['fwtype']!=1}display:none{/if}">
                                <label class="layui-form-label"></label>
                                <div class="layui-input-inline" style="width:auto">
                                    <table id="setcategorydiv"  class="layui-table" style="width:500px">
                                        <thead>
                                        <tr>
                                            <th>分类ID</th>
                                            <th>分类名称</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        {if $categorydata}
                                        {foreach $categorydata as $k=>$ff}
                                        <tr class="categorylisttr"><td>{$ff.id}</td><td>{$ff.name}</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delCategory(this,{$ff.id})">删除</button></td></tr>
                                        {/foreach}
                                        {/if}
                                        <tr id="categoryaddtr">
                                            <td colspan="3"><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="showChooseCategory()">添加</button></td>
                                        </tr>
                                    </table>
                                    <input type="hidden" name="info[categoryids]" value="{$info.categoryids}"/>
                                </div>
                            </div>
                            <script>
                            var chooseCategoryLayer;
                            function showChooseCategory(){
                                chooseCategoryLayer = layer.open({type:2,title:'选择商品分类',content:"{:url('ShopCategory/choosecategory')}",area:['1000px','600px'],shadeClose:true});
                            }
                            function chooseCategory(fid,fname){
                                layer.close(chooseCategoryLayer);
                                var categoryids = [];
                                var isadd = 0;
                                $('.categorylisttr').each(function(){
                                    var thisfid = $(this).find('td:eq(0)').html();
                                    if(thisfid == fid){
                                        isadd = 1
                                        dialog('该分类已添加过了');
                                    }
                                    categoryids.push(thisfid)
                                })
                                if(isadd == 0){
                                    categoryids.push(fid)
                                    $("input[name='info[categoryids]']").val(categoryids.join(','));
                                    $('#categoryaddtr').before('<tr class="categorylisttr"><td>'+fid+'</td><td>'+fname+'</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delCategory(this,'+fid+')">删除</button></td></tr>');
                                }
                                console.log(categoryids)
                            }
                            function delCategory(obj,fid){
                                $(obj).parent().parent().remove();
                                var categoryids = [];
                                $('.categorylisttr').each(function(){
                                    categoryids.push($(this).find('td:eq(0)').html())
                                })
                                $("input[name='info[categoryids]']").val(categoryids.join(','));
                            }
                            </script>
                            <div class="fwtype2" style="clear:both;{if $info['fwtype']!=2}display:none{/if}">
                                <label class="layui-form-label"></label>
                                <div class="layui-input-inline" style="width:auto">
                                    <table id="setproductdiv"  class="layui-table" style="width:700px">
                                        <thead>
                                        <tr>
                                            <th>商品ID</th>
                                            <th>商品名称</th>

                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        {if $productdata}
                                        {foreach $productdata as $k=>$ff}
                                        <tr class="productlisttr">
                                            <td>{$ff.id}</td>
                                            <td>{$ff.name}</td>
                                            <td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delProduct(this,{$ff.id})">删除</button></td>
                                        </tr>
                                        {/foreach}
                                        {/if}
                                        <tr id="productaddtr">
                                            <td colspan="3"><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="showChooseProduct()">添加</button></td>
                                        </tr>
                                    </table>
                                    <input type="hidden" name="info[productids]" value="{$info.productids}"/>
                                </div>
                            </div>
                            <script>
                            var cxtype = '{$info.type}';
                            var chooseProductLayer;
                            function showChooseProduct(){
                                chooseProductLayer = layer.open({type:2,title:'选择商品',content:"{:url('ShopProduct/chooseproduct')}/hidebid/1",area:['1000px','600px'],shadeClose:true});
                            }
                            function choosepro(res){
                                var product = res.product
                                layer.close(chooseProductLayer);
                                var productids = [];
                                var isadd = 0;
                                $('.productlisttr').each(function(){
                                    var thisfid = $(this).find('td:eq(0)').html();
                                    if(thisfid == product.id){
                                        isadd = 1
                                        dialog('该商品已添加过了');
                                    }
                                    productids.push(thisfid)
                                })
                                if(isadd == 0){
                                    productids.push(product.id)
                                    $("input[name='info[productids]']").val(productids.join(','));
                                    $('#productaddtr').before('<tr class="productlisttr"><td>'+product.id+'</td><td>'+product.name+'</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delProduct(this,'+product.id+')">删除</button></td></tr>');
                                }
                                console.log(productids)
                            }
                            function delProduct(obj,fid){
                                $(obj).parent().parent().remove();
                                var productids = [];
                                $('.productlisttr').each(function(){
                                    productids.push($(this).find('td:eq(0)').html())
                                })
                                $("input[name='info[productids]']").val(productids.join(','));
                            }
                            </script>
                        </div>
												<div class="layui-form-item">
                            <label class="layui-form-label">复购金额：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="info[price]" value="{$info.price}" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux" style="margin-left:10px;">元</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">复购人群：</label>
                            <div class="layui-input-inline" style="width:600px">
                                <input type="checkbox" name="info[gettj][]" value="-1" title="所有人" {if in_array('-1',$info['gettj'])}checked{/if}/>
                                <!-- <input type="checkbox" name="info[gettj][]" value="0" title="关注用户" {if in_array('0',$info['gettj'])}checked{/if}/> -->
                                {foreach $memberlevel as $v}
                                <input type="checkbox" name="info[gettj][]" value="{$v.id}" title="{$v.name}" {if in_array($v['id'],$info['gettj'])}checked{/if}/>
                                {/foreach}
                            </div>
                        </div>
												
                        <div class="layui-form-item">
                            <label class="layui-form-label">未复购表现：</label>
                            <div class="layui-input-inline" style="width:300px">
                                <input type="radio" name="info[wfgtype]" value="0" {if $info['wfgtype']==0}checked{/if} title="冻结佣金" lay-filter="wfgtypeset"/>
                                <input type="radio" name="info[wfgtype]" value="1" {if $info['wfgtype']==1}checked{/if} title="降低等级" lay-filter="wfgtypeset"/>
                            </div>
                        </div>

												<div class="layui-form-item" {if $info['wfgtype']!=0}style="display:none"{/if} id="wfgtypeset0">
														<label class="layui-form-label">提现提示语：</label>
														<div class="layui-input-inline" style="width:500px">
																<input type="text" name="info[wfgtxtips]" value="{$info.wfgtxtips}" class="layui-input">
														</div>
												</div>
												<div class="layui-form-item" {if $info['wfgtype']!=1}style="display:none"{/if} id="wfgtypeset1">
														<label class="layui-form-label">选择等级：</label>
														<div class="layui-input-inline" style="width:600px">
																{foreach $memberlevel as $v}
                                <input type="radio" name="info[wfglvid]" value="{$v.id}" title="{$v.name}" {if $v['id']==$info['wfglvid']}checked{/if}/>
                                {/foreach}
														</div>
												</div>

                        <!-- <div class="layui-form-item">
                            <label class="layui-form-label">序号：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="info[sort]" value="{$info.sort}" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux" style="margin-left:10px;">用于排序,越大越靠前</div>
                        </div> -->
												
                        <div class="layui-form-item">
                            <label class="layui-form-label">状态：</label>
                            <div class="layui-input-inline" style="width:300px">
                                <input type="radio" name="info[status]" value="1" {if $info['status']==1}checked{/if} title="开启" />
                                <input type="radio" name="info[status]" value="0" {if $info['status']==0}checked{/if} title="关闭" />
                            </div>
                            <div class="layui-form-mid layui-word-aux"></div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="formsubmit">提 交</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
  </div>
    {include file="public/js"/}
    <script>
    layui.form.on('radio(typeset)',function(data){
        if(data.value == 0){
            $('#typeset0').show();
            $('#typeset1').hide();
        }else{
            $('#typeset0').hide();
            $('#typeset1').show();
        }
    })
    layui.form.on('radio(wfgtypeset)',function(data){
        if(data.value == 0){
            $('#wfgtypeset0').show();
            $('#wfgtypeset1').hide();
        }else{
            $('#wfgtypeset0').hide();
            $('#wfgtypeset1').show();
        }
    })
    layui.form.on('radio(fwtype)',function(data){
        if(data.value==1){
            $('.fwtype1').show();
            $('.fwtype2').hide();
        }else if(data.value==2){
            $('.fwtype1').hide();
            $('.fwtype2').show();
        }else{
            $('.fwtype1').hide();
            $('.fwtype2').hide();
        }
    })
		

    layui.form.on('submit(formsubmit)', function(obj){
        console.log(obj)
        var field = obj.field
        var index = layer.load();
        $.post("{:url('save')}",field,function(data){
            layer.close(index);
            dialog(data.msg,data.status);
            if(data.status == 1){
                setTimeout(function(){
                    parent.layer.closeAll();
                    parent.tableIns.reload()
                },1000)
            }
        })
    })
  </script>
    {include file="public/copyright"/}
</body>
</html>