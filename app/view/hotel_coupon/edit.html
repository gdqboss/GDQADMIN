<!DOCTYPE html><!--custom_file(hotel)-->
<html>
<head>
  <meta charset="utf-8">
  <title>{:t('优惠券')}设置</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  {include file="public/css"/}
</head>
<body>
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-card layui-col-md12">
				<div class="layui-card-header">
					{if !$info['id']}<i class="fa fa-plus"></i> 添加{:t('优惠券')}{else}<i class="fa fa-pencil"></i> 编辑{:t('优惠券')}{/if}
					<i class="layui-icon layui-icon-close" style="font-size:18px;font-weight:bold;cursor:pointer" onclick="closeself()"></i>
				</div>
				<div class="layui-card-body" pad15>
					<div class="layui-form form-label-w6" lay-filter="">
						<input type="hidden" name="info[id]" value="{$info['id']}">
						<input type="hidden" name="info[type]" value="6">
					   
						<div class="layui-form-item">
							<label class="layui-form-label">{:t('优惠券')}名称：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[name]" value="{$info.name}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
							</div>
						</div>
					   
						<div class="layui-form-item coupon_type5" {if $info['type'] ==51}style="display:none"{/if}>
							<label class="layui-form-label">优惠金额：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[money]" value="{$info.money}" autocomplete="off" class="layui-input">
							</div>
							<div class="layui-form-mid">元</div>
							<div class="layui-word-aux layui-clear">注：用于订单抵扣时，{:t('优惠券')}只能抵消房型金额</div>
						</div>
						<div class="layui-form-item coupon_type5" {if $info['type'] ==51}style="display:none"{/if}>
							<label class="layui-form-label">最低消费金额：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[minprice]" value="{$info.minprice|default=0}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
							</div>
							<div class="layui-form-mid">元</div>
							<div class="layui-word-aux layui-clear"> 注：消费金额达到最低消费金额才可使用{:t('优惠券')}，无门槛{:t('优惠券')}请填0</div>
						</div>
						<div class="layui-form-item coupon_type10" {if $info['type']!=10}style="display:none"{/if}>
							<label class="layui-form-label">折扣比例：</label>
							<div class="layui-input-inline">
							  <input type="text" name="info[discount]" value="{$info.discount}" autocomplete="off" class="layui-input">
							</div>
							<div class="layui-form-mid">%</div>
							<div class="layui-word-aux" style="clear:both;margin-left:125px">例如9折{:t('优惠券')}则填写90</div>
						</div>			
		  
						<div class="layui-form-item">
							<label class="layui-form-label">适用范围：</label>
							<div class="layui-input-inline" style="width:500px">
								<input type="radio" name="info[fwtype]" value="0" {if $info['fwtype']==0}checked{/if} title="全场通用" lay-filter="fwtype"/>
								<input type="radio" name="info[fwtype]" value="2" {if $info['fwtype']==2}checked{/if} title="指定房型" lay-filter="fwtype"/>
							</div>
						
							<div class="fwtype2 fwtypeExtend" style="clear:both;{if $info['fwtype']!=2}display:none{/if}">
								<label class="layui-form-label"></label>
								<div class="layui-input-inline" style="width:auto">
									<table id="setproductdiv"  class="layui-table" style="width:500px">
										<thead>
										<tr>
											<th>房型ID</th>
											<th>房型名称</th>
											<th>操作</th>
										</tr>
										</thead>
										{if $hotelroom}
										{foreach $hotelroom as $k=>$ff}
										<tr class="roomlisttr"><td>{$ff.id}</td><td>{$ff.name}</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delHotelroom(this,{$ff.id})">删除</button></td></tr>
										{/foreach}
										{/if}
										<tr id="roomaddtr">
											<td colspan="3"><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="showChooseProduct()">添加</button></td>
										</tr>
									</table>
									<input type="hidden" name="info[roomids]" value="{$info.roomids}"/>
								</div>
							</div>
							<script>
							var chooseHotelLayer;
							function showChooseProduct(){
								chooseHotelLayer  = layer.open({type:2,title:'选择房型',content:"{:url('HotelRoom/choosehotelroom')}/hidebid/1",area:['1000px','600px'],shadeClose:true});
							}
							function chooseHotel(res){
										console.log(res)
										var product = res.hotel
										layer.close(chooseHotelLayer);
										var roomids = [];
										var isadd = 0;
										$('.hotellisttr').each(function(){
											var thisfid = $(this).find('td:eq(0)').html();
											if(thisfid == product.id){
												isadd = 1
												dialog('该商品已添加过了');
											}
											roomids.push(thisfid)
										})
									 
										if(isadd == 0){
											roomids.push(product.id)
											$("input[name='info[roomids]']").val(roomids.join(','));
											$('#hoteladdtr').before('<tr class="hotellisttr"><td>'+product.id+'</td><td>'+product.name+'</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delhotel(this,'+product.id+')">删除</button></td></tr>');
										}
										console.log(roomids)
						  }
						   function delhotel(obj,fid){
								$(obj).parent().parent().remove();
								var roomids = [];
								$('.hotellisttr').each(function(){
									roomids.push($(this).find('td:eq(0)').html())
								})
								$("input[name='info[hotelids]']").val(roomids.join(','));
							}

							function chooseHotelRoom (res){
								console.log(res);
								var room = res.room
								layer.close(chooseHotelLayer);
								var roomids = [];
								var isadd = 0;
								$('.roomlisttr').each(function(){
									var thisfid = $(this).find('td:eq(0)').html();
									if(thisfid == room.id){
										isadd = 1
										dialog('该房型已添加过了');
									}
									roomids.push(thisfid)
								})
								if(isadd == 0){
									roomids.push(room.id)
									$("input[name='info[roomids]']").val(roomids.join(','));
									$('#roomaddtr').before('<tr class="roomlisttr"><td>'+room.id+'</td><td>'+room.name+'</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delHotelroom(this,'+room.id+')">删除</button></td></tr>');
								}
								console.log(roomids)
							}
							function delHotelroom(obj,fid){
								$(obj).parent().parent().remove();
								var roomids = [];
								$('.roomlisttr').each(function(){
									roomids.push($(this).find('td:eq(0)').html())
								})
								$("input[name='info[roomids]']").val(roomids.join(','));
							}
							</script>
							
						</div>
					

						<div class="layui-form-item">
							<label class="layui-form-label">使用说明：</label>
							<div class="layui-input-inline" style="width:300px">
								<textarea name="info[usetips]" class="layui-textarea">{$info.usetips}</textarea>
							</div>
							<div class="layui-form-mid layui-word-aux"></div>
						</div>

						<div class="layui-form-item">
							<label class="layui-form-label">有效期：</label>
							<div class="layui-input-inline" style="width:500px">
								<input type="radio" name="info[yxqtype]" value="1" title="固定时间范围" {if !$info['id'] || $info['yxqtype']==1}checked{/if} lay-filter="yxqtype"/>
								<input type="radio" name="info[yxqtype]" value="2" title="领取后时长" {if $info['yxqtype']==2}checked{/if} lay-filter="yxqtype"/>
								<input type="radio" name="info[yxqtype]" value="3" title="领取后时长（次日起）" {if $info['yxqtype']==3}checked{/if} lay-filter="yxqtype"/>
							</div>
						</div>
						<div class="layui-form-item yxqtimeitem" id="yxqtimeitem_1" {if $info['id'] && $info['yxqtype']!=1}style="display:none"{/if}>
							<label class="layui-form-label"></label>
							<div class="layui-form-mid">有效期时间</div>
							<div class="layui-input-inline" style="width:300px">
								<input type="text" name="info[yxqtime]" value="{$info.yxqtime}" id="yxqtime" autocomplete="off" class="layui-input"/>
							</div>
						</div>
						<div class="layui-form-item yxqtimeitem" id="yxqtimeitem_2" {if $info['yxqtype']!=2}style="display:none"{/if}>
							<label class="layui-form-label"></label>
							<div class="layui-form-mid">领取后</div>
							<div class="layui-input-inline" style="width:70px">
								<input type="text" name="yxqdate2" value="{$info.yxqdate}" class="layui-input"/>
							</div>
							<div class="layui-form-mid">天内有效</div>
						</div>
						  <div class="layui-form-item yxqtimeitem" id="yxqtimeitem_3" {if $info['yxqtype']!=3}style="display:none"{/if}>
							  <label class="layui-form-label"></label>
							  <div class="layui-form-mid">领取后</div>
							  <div class="layui-input-inline" style="width:70px">
								  <input type="text" name="yxqdate3" value="{$info.yxqdate}" class="layui-input"/>
							  </div>
							  <div class="layui-form-mid">天内有效（次日0点开始计算有效期）</div>
						  </div>


		<div class="layui-form-item">
							<label class="layui-form-label"><span class="redstar">*</span>参与条件：</label>
							<div class="layui-input-inline" style="width:600px">
								<input type="checkbox" name="info[gettj][]" value="-1" title="所有人" {if in_array('-1',$info['gettj'])}checked{/if}/>
								<!-- <input type="checkbox" name="info[gettj][]" value="0" title="关注用户" {if in_array('0',$info['gettj'])}checked{/if}/> -->
								{foreach $memberlevel as $v}
								<input type="checkbox" name="info[gettj][]" value="{$v.id}" title="{$v.name}" {if in_array($v['id'],$info['gettj'])}checked{/if}/>
								{/foreach}
							</div>
						</div>
						
						<div class="layui-form-item">
							<label class="layui-form-label">所需金额：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[price]" value="{$info.price|default=0}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
							</div>
							<div class="layui-form-mid layui-word-aux">需要消耗多少钱购买</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">所需{:t('积分')}：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[score]" value="{$info.score|default=0}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
							</div>
							<div class="layui-form-mid layui-word-aux">需要消耗多少{:t('积分')}兑换</div>
						</div>

						<div class="layui-form-item">
							<label class="layui-form-label">库存：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[stock]" value="{$info.stock|default=100}" class="layui-input">
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">每人可领取数：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[perlimit]" value="{$info['perlimit']}" class="layui-input">
							</div>
							<div class="layui-form-mid layui-word-aux">每人最多可领取多少张</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">开始时间：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[starttime]" autocomplete="off" value="{$info.starttime}" lay-verify="required" lay-verType="tips" class="layui-input" id="starttime">
							</div>
							<div class="layui-form-mid layui-word-aux">活动开始时间</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">结束时间：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[endtime]" autocomplete="off" value="{$info.endtime}" lay-verify="required" lay-verType="tips" class="layui-input" id="endtime">
							</div>
							<div class="layui-form-mid layui-word-aux">活动结束时间</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">序号：</label>
							<div class="layui-input-inline">
								<input type="text" name="info[sort]" value="{$info.sort}" class="layui-input">
							</div>
							<div class="layui-form-mid layui-word-aux" style="margin-left:10px;">用于排序,越大越靠前</div>
						</div>
						
						<div class="layui-form-item">
							<label class="layui-form-label">可直接领取：</label>
							<div class="layui-input-inline">
								<input type="radio" name="info[tolist]" value="1" {if !$info['id'] || $info['tolist']==1}checked{/if} title="是"/>
								<input type="radio" name="info[tolist]" value="0" {if $info['id'] && $info['tolist']==0}checked{/if} title="否"/>
							</div>
							<div class="layui-form-mid layui-word-aux" style="margin-left:10px;">是否可以在领券中心直接领取</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">使用范围：</label>
							<div class="layui-input-inline" style="width: 430px">
								<input type="radio" name="info[isgive]" value="0" {if !$info['id'] || $info['isgive']==0}checked{/if} title="仅自用" lay-filter="isgive"/>
								<input type="radio" name="info[isgive]" value="1" {if $info['id'] && $info['isgive']==1}checked{/if} title="自用+转赠" lay-filter="isgive"/>
								<input type="radio" name="info[isgive]" value="2" {if  $info['id'] && $info['isgive']==2}checked{/if} title="仅转赠" lay-filter="isgive"/>
							</div>
							<div class="layui-form-mid layui-word-aux" style="margin-left:10px;">{:t('优惠券')}使用范围，自用或转赠</div>
						</div>
	
						<div class="layui-form-item">
							<label class="layui-form-label">支付后赠送：</label>
							<div class="layui-input-inline">
								<input type="radio" name="info[paygive]" value="0" {if !$info['id'] || $info['paygive']==0}checked{/if} title="关闭" lay-filter="paygive"/>
								<input type="radio" name="info[paygive]" value="1" {if $info['id'] && $info['paygive']==1}checked{/if} title="开启" lay-filter="paygive"/>
							</div>
							<div class="layui-form-mid layui-word-aux" style="margin-left:10px;">支付成功后自动发放{:t('优惠券')}</div>
						</div>
						<div style="{if !$info['id'] || $info['paygive']==0}display:none{/if}" id="paygiveset">
							<div class="layui-form-item">
								<label class="layui-form-label">支付赠送场景：</label>
								<div class="layui-input-inline" style="width:600px">
									{php} $paygive_scenes = explode(',',$info['paygive_scene']);{/php}
									<input type="checkbox" name="info[paygive_scene][]" value="hotel" {if in_array('hotel',$paygive_scenes)}checked{/if} title="下单"/>
									<input type="checkbox" name="info[paygive_scene][]" value="recharge" {if in_array('recharge',$paygive_scenes)}checked{/if} title="充值"/>
									<!-- 约车 -->
									{if getcustom('car_hailing')}
									{if $auth['car_hailing']}
									<input type="checkbox" name="info[paygive_scene][]" value="car_hailing" {if in_array('car_hailing',$paygive_scenes)}checked{/if} title="约车"/>
									{/if}
									{/if}
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">支付金额范围：</label>
								<div class="layui-input-inline" style="width:100px">
									<input type="text" name="info[paygive_minprice]" value="{$info.paygive_minprice|default=0}" class="layui-input">
								</div>
								<div class="layui-form-mid">-</div>
								<div class="layui-input-inline" style="width:100px">
									<input type="text" name="info[paygive_maxprice]" value="{$info.paygive_maxprice|default=9999}" class="layui-input">
								</div>
								<div class="layui-form-mid">元</div>
							</div>
						</div>
						
						<div class="layui-form-item">
							<label class="layui-form-label"></label>
							<div class="layui-input-block">
								<button class="layui-btn" lay-submit lay-filter="formsubmit">提 交</button>
							</div>
						</div>
					</div>
					
				</div>
			</div>
    </div>
  </div>
	{include file="public/js"/}
	<script>
	
	layui.form.on('radio(yxqtype)',function(data){
		$('.yxqtimeitem').hide();
		$('#yxqtimeitem_'+data.value).show();
	})
	layui.form.on('radio(isgive)',function(data){
		if(data.value==1 || data.value==2){
			$('#isgive').show();
		}else{
			$('#isgive').hide();
		}
	})
	layui.form.on('radio(paygive)',function(data){
		if(data.value==1){
			$('#paygiveset').show();
		}else{
			$('#paygiveset').hide();
		}
	})
	layui.form.on('radio(fwtype)',function(data){
		$('.fwtypeExtend').hide();
		$('.fwtype' + data.value).show();
	})
	layui.form.on('radio(buyprogive)',function(data){
		if(data.value==1){
			$('.buyprogive').show();
		}else{
			$('.buyprogive').hide();
		}
	})
	layui.form.on('radio(buy_restaurant_product_give)',function(data){
		if(data.value==1){
			$('.buy_restaurant_product_give').show();
		}else{
			$('.buy_restaurant_product_give').hide();
		}
	})
	layui.laydate.render({ 
		elem: '#starttime'
		,type: 'datetime'
		,range: false,
		trigger: 'click'
	});
	layui.laydate.render({ 
		elem: '#endtime'
		,type: 'datetime'
		,range: false,
		trigger: 'click'
	});
	layui.laydate.render({ 
		elem: '#yxqtime'
		,type: 'datetime'
		,range: '~',
		trigger: 'click'
	});

	layui.form.on('submit(formsubmit)', function(obj){
		var field = obj.field
		var index = layer.load();
		$.post("{:url('save')}",field,function(data){
			layer.close(index);
			dialog(data.msg,data.status);
			if(data.status == 1){
				setTimeout(function(){
					parent.layer.closeAll();
					parent.tableIns.reload()
				},1000)
			}
		})
	})
  </script>
	{include file="public/copyright"/}
</body>
</html>