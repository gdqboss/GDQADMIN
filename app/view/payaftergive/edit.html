<!DOCTYPE html><!--custom_file(payaftergive)-->
<html>
<head>
  <meta charset="utf-8">
  <title>支付后赠送设置</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  {include file="public/css"/}
</head>
<body>
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-card layui-col-md12">
		<div class="layui-card-header">
		{if !$info['id']}<i class="fa fa-plus"></i> 添加支付后赠送{else}<i class="fa fa-pencil"></i> 编辑支付后赠送{/if}
          <i class="layui-icon layui-icon-close" style="font-size:18px;font-weight:bold;cursor:pointer" onclick="closeself()"></i>
		</div>
		<div class="layui-card-body" pad15>
			<div class="layui-form form-label-w6" lay-filter="">
				<input type="hidden" name="info[id]" value="{$info['id']}">
				<div class="layui-form-item">
					<label class="layui-form-label">活动名称：</label>
					<div class="layui-input-inline" style="width:300px">
						<input type="text" name="info[name]" value="{$info.name}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">参与条件：</label>
					<div class="layui-input-inline" style="width:600px">
						<input type="checkbox" name="info[gettj][]" value="-1" title="所有人" {if in_array('-1',$info['gettj'])}checked{/if}/>
						<!-- <input type="checkbox" name="info[gettj][]" value="0" title="关注用户" {if in_array('0',$info['gettj'])}checked{/if}/> -->
						{foreach $memberlevel as $v}
						<input type="checkbox" name="info[gettj][]" value="{$v.id}" title="{$v.name}" {if in_array($v['id'],$info['gettj'])}checked{/if}/>
						{/foreach}
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">赠送场景：</label>
					<div class="layui-input-inline" style="width:600px">
						{php} $paygive_scenes = explode(',',$info['paygive_scene']);{/php}
						<input type="checkbox" name="info[paygive_scene][]" value="shop" {if in_array('shop',$paygive_scenes)}checked{/if} title="商城"/>
						<input type="checkbox" name="info[paygive_scene][]" value="scoreshop" {if in_array('scoreshop',$paygive_scenes)}checked{/if} title="积分兑换"/>
						<input type="checkbox" name="info[paygive_scene][]" value="collage" {if in_array('collage',$paygive_scenes)}checked{/if} title="拼团"/>
						<input type="checkbox" name="info[paygive_scene][]" value="kanjia" {if in_array('kanjia',$paygive_scenes)}checked{/if} title="砍价"/>
						<input type="checkbox" name="info[paygive_scene][]" value="seckill" {if in_array('seckill',$paygive_scenes)}checked{/if} title="秒杀"/>
						<input type="checkbox" name="info[paygive_scene][]" value="tuangou" {if in_array('tuangou',$paygive_scenes)}checked{/if} title="团购"/>
						<input type="checkbox" name="info[paygive_scene][]" value="lucky_collage" {if in_array('lucky_collage',$paygive_scenes)}checked{/if} title="幸运拼团"/>
						<input type="checkbox" name="info[paygive_scene][]" value="recharge" {if in_array('recharge',$paygive_scenes)}checked{/if} title="充值"/>
						<input type="checkbox" name="info[paygive_scene][]" value="maidan" {if in_array('maidan',$paygive_scenes)}checked{/if} title="买单收款"/>
						<input type="checkbox" name="info[paygive_scene][]" value="restaurant" {if in_array('restaurant',$paygive_scenes)}checked{/if} title="餐饮"/>
						{if getcustom('car_hailing')}
						<input type="checkbox" name="info[paygive_scene][]" value="car_hailing" {if in_array('car_hailing',$paygive_scenes)}checked{/if} title="约车"/>
						{/if}
					</div>
				</div>
				
				<div class="layui-form-item">
					<label class="layui-form-label">每人限制次数：</label>
					<div class="layui-input-inline" style="width:100px">
						<input type="text" name="info[limittimes]" value="{$info.limittimes}" lay-verify="required" lay-verType="tips" autocomplete="off" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux">每个人最多可赠送多少次 0表示不限制</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">支付金额：</label>
					<div class="layui-input-inline" style="width:100px">
						<input type="text" name="info[pricestart]" value="{$info.pricestart|default=0}" class="layui-input">
					</div>
					<div class="layui-form-mid">-</div>
					<div class="layui-input-inline" style="width:100px">
						<input type="text" name="info[priceend]" value="{$info.priceend|default=9999}" class="layui-input">
					</div>
					<div class="layui-form-mid">元</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">开始时间：</label>
					<div class="layui-input-inline">
						<input type="text" name="info[starttime]" autocomplete="off" value="{$info.starttime}" lay-verify="required" lay-verType="tips" class="layui-input" id="starttime">
					</div>
					<div class="layui-form-mid layui-word-aux">活动开始时间</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">结束时间：</label>
					<div class="layui-input-inline">
						<input type="text" name="info[endtime]" autocomplete="off" value="{$info.endtime}" lay-verify="required" lay-verType="tips" class="layui-input" id="endtime">
					</div>
					<div class="layui-form-mid layui-word-aux">活动结束时间</div>
				</div>

				{if $bid == 0}
				<div class="layui-form-item">
					<label class="layui-form-label">赠送{:t('余额')}：</label>
					<div class="layui-input-inline">
						<input type="text" name="info[money]" value="{$info.money|default=0}" autocomplete="off" class="layui-input">
					</div>
					<div class="layui-form-mid">元</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">赠送{:t('积分')}：</label>
					<div class="layui-input-inline">
						<input type="text" name="info[score]" value="{$info.score|default=0}" autocomplete="off" class="layui-input">
					</div>
					<div class="layui-word-aux" style="clear:both;margin-left:125px"></div>
				</div>
				{/if}

				<div class="layui-form-item">
					<label class="layui-form-label">赠送抽奖：</label>
					<div class="layui-input-inline layui-module-itemL">
						<div>抽奖次数</div>
						<input type="text" name="info[choujiangtimes]" class="layui-input" value="{$info.choujiangtimes}">
					</div>
					<div class="layui-input-inline layui-module-itemL">
						<div>抽奖活动ID</div>
						<input type="text" name="info[choujiangid]" class="layui-input" value="{$info.choujiangid}">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">赠送{:t('优惠券')}：</label>
					<div class="layui-input-inline" style="width:500px">
						<input type="radio" name="info[give_coupon]" value="0" {if $info['give_coupon']==0}checked{/if} title="关闭" lay-filter="give_coupon"/>
						<input type="radio" name="info[give_coupon]" value="1" {if $info['give_coupon']==1}checked{/if} title="开启" lay-filter="give_coupon"/>
					</div>
					<div class="give_coupon" style="clear:both;{if $info['give_coupon']!=1}display:none{/if}">
						<label class="layui-form-label"></label>
						<div class="layui-input-inline" style="width:auto; overflow: hidden;">
							<table class="layui-table choose-coupon" style="width:500px" id="choose-coupon">
								<thead>
								<tr>
									<th>ID</th>
									<th>名称</th>
									<th>库存</th>
									<th>操作</th>
								</tr>
								</thead>
								{if $couponList}
								{foreach $couponList as $k=>$ff}
								<tr class="choose-tr-list"><td>{$ff.id}</td><td>{$ff.name}</td><td>{$ff.stock}</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delChooseTr(this,{$ff.id})">删除</button></td></tr>
								{/foreach}
								{/if}
								<tr class="choose-tr-add">
									<td colspan="4"><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="showChooseCoupon()">添加</button></td>
								</tr>
							</table>
							<div class="layui-form-mid layui-word-aux">请确认{:t('优惠券')}的有效期、库存有效</div>
							<input type="hidden" name="info[coupon_ids]" value="{$info.coupon_ids}"/>
						</div>
					</div>

					<script>
						var chooseCouponLayer;
						function showChooseCoupon(){
							chooseCouponLayer = layer.open({type:2,title:'选择{:t(\'优惠券\')}',content:"{:url('Coupon/choosecoupon')}&type=all&module=payaftergive",area:['1000px','600px'],shadeClose:true});
						}
						function choosecoupon(res){
							var detail = res;
							var chooseClassName = '.choose-coupon';
							layer.close(chooseCouponLayer);
							var objIds = [];
							var isadd = 0;
							$(chooseClassName).find('.choose-tr-list').each(function(){
								var thisfid = $(this).find('td:eq(0)').html();
								//if(thisfid == detail.id){
								//	isadd = 1
								//	dialog('该项已添加过了');
								//}
								objIds.push(thisfid)
							})
							if(isadd == 0){
								objIds.push(detail.id)
								$("input[name='info[coupon_ids]']").val(objIds.join(','));
								var tr = '<tr class="choose-tr-list"><td>'+detail.id+'</td><td>'+detail.name+'</td><td>'+detail.stock+'</td><td><button type="button" class="layui-btn layui-btn-sm layui-btn-primary" onclick="delChooseTr(this,'+detail.id+')">删除</button></td></tr>';
								$(chooseClassName).find('.choose-tr-add').before(tr);
							}
							// $(chooseClassName).find('.choose-tr-add').hide();
						}
						function delChooseTr(obj,fid){
							$(obj).closest('.choose-tr-list').remove();
							var objIds = [];
							$('#choose-coupon').find('.choose-tr-list').each(function(){
								objIds.push($(this).find('td:eq(0)').html())
							})
							console.log(objIds)
							$("input[name='info[coupon_ids]']").val(objIds.join(','));
							// $(obj).closest('table').find('.choose-tr-add').show();
						}
					</script>
				</div>

				<div class="layui-form-item">
					<div class="layui-form-label">支付后跳转：</div>
					<div class="layui-input-inline" style="width:300px">
						<input class="layui-input" name="info[tourl]" id="tourl" value="{$info.tourl}"/>
					</div>
					<div class="layui-btn layui-btn-primary" style="float:left" onclick="chooseUrl2('tourl')">选择链接</div>
				</div>
				<!-- <div class="layui-form-item">
					<div class="layui-form-label">跳转按钮文本：</div>
					<div class="layui-input-inline">
						<input class="layui-input" name="info[btntext]" value="{$info.btntext}"/>
					</div>
				</div> -->
				<div class="layui-form-item">
					<label class="layui-form-label">序号：</label>
					<div class="layui-input-inline">
						<input type="text" name="info[sort]" value="{$info.sort}" class="layui-input">
					</div>
					<div class="layui-form-mid layui-word-aux" style="margin-left:10px;">用于排序,越大越靠前</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label"></label>
					<div class="layui-input-block">
						<button class="layui-btn" lay-submit lay-filter="formsubmit">提 交</button>
					</div>
				</div>
			</div>

		</div>
	  </div>
    </div>
  </div>
	{include file="public/js"/}
	<script>

	layui.form.on('radio(give_coupon)',function(data){
		if(data.value==1){
			$('.give_coupon').show();
		}else{
			$('.give_coupon').hide();
		}
	})
	layui.laydate.render({ 
		elem: '#starttime'
		,type: 'datetime'
		,range: false,
		trigger: 'click'
	});
	layui.laydate.render({ 
		elem: '#endtime'
		,type: 'datetime'
		,range: false,
		trigger: 'click'
	});
	layui.laydate.render({ 
		elem: '#yxqtime'
		,type: 'datetime'
		,range: '~',
		trigger: 'click'
	});
	
	var chooseUrlField = '';
	function chooseUrl2(field){
		chooseUrlField = field;
		layer.open({type:2,shadeClose:true,area:['1200px', '650px'],'title':'选择链接',content:"{:url('DesignerPage/chooseurl')}&callback=chooseLink2"})
	}
	function chooseLink2(urlname,url){
		$("#"+chooseUrlField).val(url);
	}
	layui.form.on('radio(is_bind_bid)', function(data){
		if(data.value==1){
			$('#bindBidNames').show();
			var pgid = "{$info.id}";
			var index = layer.load();
			$.post("{:url('getBusinessList')}",{pgid:pgid},function(res){
				layer.close(index);
				if(res.status==1){
					var html = `<div class="layui-form" style="padding: 10px;">
									<div class="layui-form-item">
										<div class="layui-input-inline" style="width: 100%">`;
						var datalist = res.datalist
					for (let i=0;i<datalist.length;i++){
						html += `<input type="checkbox" class="biditem" name="bids[]" value="`+datalist[i].id+`" `+datalist[i].checked+` title="`+datalist[i].name+`" />`
					}
					html +=`</div></div></div>`;
					layer.open({type:1,shadeClose:true,area:['800px', '500px'],title:'选择商户',content:html,btn:['确定'],success:function(){
						layui.form.render('checkbox')
					},yes:function (){
						var bids = [];
						var bidNames = [];
						$('input[name="bids[]"]:checked').each(function (e,obj){
							bidNames.push($(obj).attr('title'))
							bids.push($(obj).val())
						})
						$('#bindbids').val(bids.join(','))
						var bnames = bidNames.join(',');
						$('#bindBidNames').html(bnames)
					    layer.closeAll();
					}})
				}else{
					layer.msg(res.msg);
				}
			});
		}else{
			$('#bindBidNames').hide();
		}
	});
	layui.form.on('submit(formsubmit)', function(obj){
		var field = obj.field
		var index = layer.load();
		$.post("{:url('save')}",field,function(data){
			layer.close(index);
			dialog(data.msg,data.status);
			if(data.status == 1){
				setTimeout(function(){
					parent.layer.closeAll();
					parent.tableIns.reload()
				},1000)
			}
		});
	});
  </script>
	{include file="public/copyright"/}
</body>
</html>