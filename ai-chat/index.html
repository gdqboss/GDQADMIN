<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>å½©ç¾ç‰¹ AI èŠå¤©å®¤</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
}

/* ç™»å½•é¡µ */
#login-page {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 20px;
    width: 90%;
    max-width: 380px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.login-box h3 {
    text-align: center;
    margin-bottom: 30px;
    color: #333;
}

/* èŠå¤©é¡µ */
#chat-page {
    display: none;
    height: 100vh;
    flex-direction: column;
}

/* å¤´éƒ¨ */
.chat-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
}
.chat-header .left { display: flex; align-items: center; gap: 10px; }
.chat-header .menu-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
.chat-header .home-btn {
   255,255, background: rgba(255,0.2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
}
.chat-header h3 { font-size: 16px; font-weight: 600; }

/* ä¾§è¾¹æ  */
.sidebar {
    position: fixed;
    left: -280px;
    top: 0;
    width: 280px;
    height: 100%;
    background: white;
    z-index: 100;
    transition: left 0.3s;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar.show { left: 0; }
.sidebar-header {
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}
.sidebar-menu { flex: 1; overflow-y: auto; }
.sidebar-menu a {
    display: block;
    padding: 15px 20px;
    color: #333;
    text-decoration: none;
    border-bottom: 1px solid #f0f0f0;
}
.sidebar-menu a:hover { background: #f5f5f5; }
.sidebar-menu a.active { background: #f0f0ff; color: #667eea; }

/* é®ç½© */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 50;
    display: none;
}
.overlay.show { display: block; }

/* æ¶ˆæ¯åŒºåŸŸ */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f0f2f5;
}
.message {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-start;
}
.message.mine { flex-direction: row-reverse; }
.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    margin: 0 10px;
}
.message.mine .message-avatar { background: #4caf50; }
.message.ai .message-avatar { 
    background: linear-gradient(135deg, #f093fb, #f5576c); 
}
.message-content { max-width: 75%; }
.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    background: white;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    word-wrap: break-word;
    line-height: 1.5;
}
.message.mine .message-bubble {
    background: #667eea;
    color: white;
    border-bottom-right-radius: 4px;
}
.message.mine .message-bubble { border-bottom-left-radius: 18px; border-bottom-right-radius: 4px; }
.message:not(.mine) .message-bubble { border-bottom-left-radius: 4px; }

/* è¾“å…¥åŒºåŸŸ */
.chat-input {
    background: white;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
}
.chat-input input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 24px;
    outline: none;
    font-size: 15px;
}
.chat-input input:focus { border-color: #667eea; }
.chat-input button {
    padding: 12px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 24px;
    font-size: 15px;
    cursor: pointer;
}
.chat-input button:active { background: #5568d3; }

/* æ¬¢è¿é¡µ */
.welcome {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}
.welcome-icon { font-size: 64px; margin-bottom: 20px; }
.welcome h2 { font-size: 20px; color: #333; margin-bottom: 10px; }
.welcome p { font-size: 14px; color: #999; }

/* åŠ è½½æ›´å¤š */
.loading-more {
    text-align: center;
    padding: 10px;
    color: #999;
    font-size: 14px;
}

/* å“åº”å¼ - å¹³æ¿ */
@media (min-width: 768px) {
    .sidebar { position: relative; left: 0; width: 260px; flex-shrink: 0; }
    .chat-page { flex-direction: row; }
    .chat-header { display: none; }
    .overlay { display: none !important; }
    .message-content { max-width: 65%; }
}

/* å“åº”å¼ - ç”µè„‘ */
@media (min-width: 1024px) {
    .sidebar { width: 280px; }
    .message-content { max-width: 55%; }
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 767px) {
    .login-box { padding: 30px 20px; }
    .chat-input { padding: 10px 12px; }
    .chat-input input { padding: 10px 14px; }
    .chat-input button { padding: 10px 18px; font-size: 14px; }
    .message-content { max-width: 80%; }
}

/* å¼¹çª— */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
}
.modal.show { display: flex; }
.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
}
.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-body { padding: 20px; }
.modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
</style>
</head>
<body>

<!-- ç™»å½•é¡µ -->
<div id="login-page">
    <div class="login-box">
        <h3>ğŸŸ å½©ç¾ç‰¹ AI èŠå¤©å®¤</h3>
        <input type="text" id="username" class="form-control" placeholder="ç”¨æˆ·å" style="width:100%;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px;font-size:15px">
        <input type="password" id="password" class="form-control" placeholder="å¯†ç " style="width:100%;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:15px;font-size:15px">
        <button onclick="doLogin()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer">ç™»å½•</button>
        <p style="text-align:center;margin-top:15px;font-size:13px;color:#888">
            æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showRegister()" style="color:#667eea;text-decoration:none">æ³¨å†Œ</a>
        </p>
    </div>
</div>

<!-- æ³¨å†Œå¼¹çª— -->
<div id="register-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight:600">æ³¨å†Œè´¦å·</span>
            <span onclick="closeModal('register')" style="font-size:24px;cursor:pointer">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="reg-username" placeholder="ç”¨æˆ·å" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
            <input type="text" id="reg-nickname" placeholder="æ˜µç§°" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
            <input type="password" id="reg-password" placeholder="å¯†ç " style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('register')" style="flex:1;padding:12px;background:#f5f5f5;border:none;border-radius:10px">å–æ¶ˆ</button>
            <button onclick="register()" style="flex:1;padding:12px;background:#667eea;color:white;border:none;border-radius:10px">æ³¨å†Œ</button>
        </div>
    </div>
</div>

<!-- èŠå¤©é¡µ -->
<div id="chat-page">
    <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="left">
            <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
            <h3>ğŸŸ AI èŠå¤©å®¤</h3>
        </div>
        <a href="/" class="home-btn">ğŸ  ä¸»é¡µ</a>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="font-size:16px;font-weight:600">ğŸŸ å½©ç¾ç‰¹</div>
            <div style="font-size:12px;margin-top:5px;opacity:0.8" id="user-display"></div>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="active" onclick="switchRoom('all')">ğŸ’¬ å…¨éƒ¨åŠ©æ‰‹</a>
            <a href="#" onclick="showSettingsModal()">âš™ï¸ èŠå¤©å®¤è®¾ç½®</a>
            <a href="#" onclick="showInviteModal()">â• é‚€è¯·å‘˜å·¥</a>
            <a href="#" onclick="showAssistantModal()">ğŸ¤– ç®¡ç†åŠ©æ‰‹</a>
            <a href="#" onclick="clearMemory()">ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†</a>
            <hr style="margin:10px 0;border:none;border-top:1px solid #eee">
            <a href="/" style="color:#666">ğŸ  è¿”å›ä¸»é¡µ</a>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="chat-messages" id="messages">
        <div class="welcome">
            <div class="welcome-icon">ğŸŸ</div>
            <h2>æ¬¢è¿æ¥åˆ°å½©ç¾ç‰¹ AI èŠå¤©å®¤</h2>
            <p>å’ŒAIåŠ©æ‰‹èŠå¤©ï¼Œæˆ–é‚€è¯·åŒäº‹åŠ å…¥</p>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input">
        <input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')doSend()">
        <button onclick="doSend()">å‘é€</button>
    </div>
</div>

<!-- é‚€è¯·å¼¹çª— -->
<div id="invite-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight:600">é‚€è¯·å‘˜å·¥</span>
            <span onclick="closeModal('invite')" style="font-size:24px;cursor:pointer">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:15px;color:#666">ç‚¹å‡»åˆ›å»ºé‚€è¯·é“¾æ¥ï¼Œåˆ†äº«ç»™å‘˜å·¥</p>
            <button onclick="createInvite()" style="width:100%;padding:12px;background:#667eea;color:white;border:none;border-radius:10px">åˆ›å»ºé‚€è¯·é“¾æ¥</button>
            <div id="invite-result" style="margin-top:15px;display:none">
                <p style="font-size:12px;color:#666;margin-bottom:5px">é‚€è¯·é“¾æ¥ï¼š</p>
                <input type="text" id="invite-link" readonly style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:12px">
            </div>
        </div>
    </div>
</div>

<!-- åŠ©æ‰‹ç®¡ç†å¼¹çª— -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span style="font-weight:600">âš™ï¸ èŠå¤©å®¤è®¾ç½®</span><span onclick="closeModal(""settings"")" style="font-size:24px;cursor:pointer">&times;</span></div>
        <div class="modal-body">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:#666">èŠå¤©å®¤åç§°</label>
            <input type="text" id="room-name-input" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:15px">
            <button onclick="saveRoomSettings()" style="width:100%;padding:12px;background:#667eea;color:white;border:none;border-radius:10px">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>

<div id="assistant-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight:600">ç®¡ç†åŠ©æ‰‹</span>
            <span onclick="closeModal('assistant')" style="font-size:24px;cursor:pointer">&times;</span>
        </div>
        <div class="modal-body">
            <button onclick="showAddAssistant()" style="width:100%;padding:12px;background:#4caf50;color:white;border:none;border-radius:10px;margin-bottom:15px">â• æ·»åŠ åŠ©æ‰‹</button>
            <div id="assistant-list"></div>
        </div>
    </div>
</div>

<script>
var currentUser = null;
var currentRoom = 'all';

var saved = localStorage.getItem('gdq_user');
if(saved){
    currentUser = JSON.parse(saved);
    showChat();
    loadMemory();
}

// æ£€æŸ¥URLä¸­çš„é‚€è¯·ç 
var urlParams = new URLSearchParams(window.location.search);
var inviteCode = urlParams.get('invite');
if(inviteCode){
    document.getElementById('register-modal').classList.add('show');
    document.getElementById('invite-code-input') && (document.getElementById('invite-code-input').value = inviteCode);
}

function doLogin(){
    var u = document.getElementById('username').value.trim();
    var p = document.getElementById('password').value;
    if(!u||!p){alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}
    var fd = new FormData();
    fd.append('username',u);fd.append('password',p);
    fetch('/ai-chat/api/user.php?action=login',{method:'POST',body:fd})
    .then(r=>r.json()).then(d=>{
        if(d.code===1){
            currentUser = d.data;
            localStorage.setItem('gdq_user',JSON.stringify(currentUser));
            showChat();
            loadMemory();
        }else{alert(d.msg);}
    });
}

function showChat(){
    document.getElementById('login-page').style.display='none';
    document.getElementById('chat-page').style.display='flex';
    document.getElementById('user-display').textContent = currentUser.nickname || currentUser.username;
    document.getElementById('msg-input').focus();
}

function loadMemory(){
    fetch('/ai-chat/api/ai.php?action=memory')
    .then(r=>r.json()).then(d=>{
        if(d.code===1 && d.data.length>0){
            renderMemory(d.data);
        }
    });
}

function renderMemory(data){
    var html = '';
    data.forEach(function(m){
        var isMine = m.role === 'user';
        var avatar = isMine ? 'ğŸ‘¤' : (m.source && m.source.indexOf('external')>=0 ? 'ğŸ¤–' : 'ğŸŸ');
        var bubbleClass = isMine ? 'mine' : (m.source && (m.source.indexOf('telegram')>=0 || m.source.indexOf('external')>=0) ? 'ai' : 'ai');
        html += '<div class="message ' + bubbleClass + '">' +
            '<div class="message-avatar">' + avatar + '</div>' +
            '<div class="message-content"><div class="message-bubble">' + m.content + '</div></div></div>';
    });
    document.getElementById('messages').innerHTML = html;
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

function doSend(){
    var input = document.getElementById('msg-input');
    var content = input.value.trim();
    if(!content || !currentUser) return;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    var html = '<div class="message mine">' +
        '<div class="message-avatar">ğŸ‘¤</div>' +
        '<div class="message-content"><div class="message-bubble">' + content + '</div></div></div>';
    document.getElementById('messages').innerHTML += html;
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    input.value = '';
    
    // è°ƒç”¨AI
    var fd = new FormData();
    fd.append('user_id',currentUser.id);
    fd.append('username',currentUser.nickname||currentUser.username);
    fd.append('message',content);
    
    fetch('/ai-chat/api/ai.php?action=chat',{method:'POST',body:fd})
    .then(r=>r.json()).then(d=>{
        if(d.code===1){
            var replyHtml = '<div class="message ai">' +
                '<div class="message-avatar">ğŸŸ</div>' +
                '<div class="message-content"><div class="message-bubble">' + d.data.reply + '</div></div></div>';
            document.getElementById('messages').innerHTML += replyHtml;
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
    });
}

function toggleMenu(){
    document.getElementById('sidebar').classList.toggle('show');
    document.querySelector('.overlay').classList.toggle('show');
}

function switchRoom(room){
    currentRoom = room;
    toggleMenu();
    if(room === 'all') loadMemory();
}

function showRegister(){ document.getElementById('register-modal').classList.add('show'); }
function closeModal(id){
    document.getElementById(id+'-modal').classList.remove('show');
}

function register(){
    var u = document.getElementById('reg-username').value.trim();
    var n = document.getElementById('reg-nickname').value.trim()||u;
    var p = document.getElementById('reg-password').value;
    if(!u||!p){alert('è¯·å¡«å†™å®Œæ•´');return;}
    var fd = new FormData();
    fd.append('username',u);fd.append('nickname',n);fd.append('password',p);
    // ç®€åŒ–ï¼šç›´æ¥åˆ›å»ºç”¨æˆ·
    fetch('/ai-chat/api/user.php?action=register',{method:'POST',body:fd})
    .then(r=>r.json()).then(d=>{
        alert(d.msg);
        if(d.code===1){
            closeModal('register');
            doLogin();
        }
    });
}

function showInviteModal(){ document.getElementById('invite-modal').classList.add('show'); toggleMenu(); }
function createInvite(){
    var fd = new FormData();
    fd.append('inviter_id',currentUser.id);
    fetch('/ai-chat/api/invite.php?action=create_invite',{method:'POST',body:fd})
    .then(r=>r.json()).then(d=>{
        if(d.code===1){
            document.getElementById('invite-result').style.display='block';
            document.getElementById('invite-link').value = d.data.link;
        }
    });
}

function showAssistantModal(){
    document.getElementById('assistant-modal').classList.add('show');
    toggleMenu();
    loadAssistants();
}

function loadAssistants(){
    fetch('/ai-chat/api/assistant.php?action=list')
    .then(r=>r.json()).then(d=>{
        var html = '';
        d.data.forEach(function(a){
            html += '<div style="padding:12px;background:#f8f9fa;border-radius:10px;margin-bottom:10px">' +
                '<div style="font-weight:600">' + a.name + '</div>' +
                '<div style="font-size:12px;color:#666">' + a.description + '</div></div>';
        });
        document.getElementById('assistant-list').innerHTML = html || 'æš‚æ— åŠ©æ‰‹';
    });
}

function clearMemory(){
    if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å¿†ï¼Ÿ')){
        fetch('/ai-chat/api/ai.php?action=clear_memory')
        .then(r=>r.json()).then(d=>{
            alert(d.msg);
            document.getElementById('messages').innerHTML = '<div class="welcome"><div class="welcome-icon">ğŸŸ</div><h2>è®°å¿†å·²æ¸…ç©º</h2></div>';
        });
    }
}
</script>
</body>
</html>
<script>
function showSettingsModal(){
    document.getElementById('settings-modal').classList.add('show');
    toggleMenu();
    // åŠ è½½å½“å‰è®¾ç½®
    if(currentUser){
        fetch('/ai-chat/api/room.php?action=get_settings&user_id='+currentUser.id)
        .then(r=>r.json()).then(d=>{
            if(d.code===1){
                document.getElementById('room-name-input').value = d.data.room_name || 'å½©ç¾ç‰¹AIèŠå¤©å®¤';
            }
        });
    }
}

function saveRoomSettings(){
    var roomName = document.getElementById('room-name-input').value.trim();
    if(!roomName){alert('è¯·è¾“å…¥èŠå¤©å®¤åç§°');return;}
    
    var fd = new FormData();
    fd.append('user_id', currentUser.id);
    fd.append('room_name', roomName);
    
    fetch('/ai-chat/api/room.php?action=update_settings',{method:'POST',body:fd})
    .then(r=>r.json()).then(d=>{
        alert(d.msg);
        if(d.code===1){
            document.getElementById('chat-title').textContent = roomName;
            document.querySelector('.chat-header h3').textContent = roomName;
            closeModal('settings');
        }
    });
}

function closeModal(id){
    document.getElementById(id+'-modal').classList.remove('show');
}
</script>
