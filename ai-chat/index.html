<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å½©ç¾ç‰¹ AI èŠå¤©</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,sans-serif;background:#f5f7fa;height:100vh}
#login-page{display:flex;align-items:center;justify-content:center;height:100vh}
.login-box{background:white;padding:30px;border-radius:16px;width:90%;max-width:350px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
#chat-page{display:none;height:100vh;flex-direction:column}
.chat-header{padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:space-between}
.chat-header h3{margin:0;font-size:18px}
.chat-messages{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa}
.message{display:flex;margin-bottom:15px}
.message.mine{flex-direction:row-reverse}
.message-avatar{width:36px;height:36px;border-radius:50%;background:#667eea;color:white;display:flex;align-items:center;justify-content:center;margin:0 10px;flex-shrink:0}
.message.mine .message-avatar{background:#4caf50}
.message-content{max-width:75%}
.message-bubble{padding:10px 15px;border-radius:16px;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.1);word-break:break-word}
.message.mine .message-bubble{background:#667eea;color:white}
.message.ai .message-avatar{background:linear-gradient(135deg,#f093fb,#f5576c)}
.message.ai .message-bubble{background:#fef3c7}
.message-time{font-size:11px;color:#999;margin-top:5px}
.message.mine .message-time{text-align:right}
.chat-input{padding:15px;background:white;display:flex;gap:10px;border-top:1px solid #eee}
.chat-input input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:24px;outline:none}
.chat-input button{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:24px;cursor:pointer}
.typing{color:#999;font-size:14px;padding:10px;text-align:center}
</style>
</head>
<body>
<!-- ç™»å½•é¡µ -->
<div id="login-page">
<div class="login-box">
<h3 style="text-align:center;margin-bottom:20px">ğŸŸ å½©ç¾ç‰¹ AI èŠå¤©</h3>
<input type="text" id="username" class="form-control mb-2" placeholder="ç”¨æˆ·å">
<input type="password" id="password" class="form-control mb-3" placeholder="å¯†ç ">
<button class="btn btn-primary w-100" onclick="doLogin()">ç™»å½•</button>
<p style="text-align:center;margin-top:15px;font-size:13px;color:#888">ç™»å½•åå¯ç›´æ¥ä¸AIèŠå¤©</p>
</div>
</div>

<!-- èŠå¤©é¡µ -->
<div id="chat-page">
<div class="chat-header">
<h3>ğŸŸ æ±Ÿå°é±¼ AIåŠ©æ‰‹</h3>
<button onclick="logout()" style="background:none;border:none;color:white;font-size:14px">é€€å‡º</button>
</div>
<div class="chat-messages" id="messages">
<div style="text-align:center;color:#888;padding:50px">
<div style="font-size:48px;margin-bottom:15px">ğŸŸ</div>
<div style="font-size:16px">ä½ å¥½ï¼æˆ‘æ˜¯æ±Ÿå°é±¼</div>
<div style="font-size:14px;color:#aaa;margin-top:10px">ç›´æ¥å‘é€æ¶ˆæ¯å¼€å§‹èŠå¤©</div>
</div>
</div>
<div class="chat-input">
<input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯ç»™æ±Ÿå°é±¼..." onkeypress="if(event.key==='Enter')doSend()">
<button onclick="doSend()">å‘é€</button>
</div>
</div>

<script>
var currentUser = null;
var aiHistory = [];

var saved = localStorage.getItem('gdq_user');
if(saved){
currentUser = JSON.parse(saved);
showChat();
}

function doLogin(){
var u = document.getElementById('username').value.trim();
var p = document.getElementById('password').value;
if(!u || !p){alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}

var fd = new FormData();
fd.append('username', u);
fd.append('password', p);

fetch('/ai-chat/api/user.php?action=login',{method:'POST',body:fd})
.then(r => r.json())
.then(d => {
if(d.code === 1){
currentUser = d.data;
localStorage.setItem('gdq_user', JSON.stringify(currentUser));
showChat();
}else{
alert(d.msg);
}
});
}

function showChat(){
document.getElementById('login-page').style.display = 'none';
document.getElementById('chat-page').style.display = 'flex';
document.getElementById('msg-input').focus();
}

function logout(){
if(confirm('ç¡®å®šé€€å‡ºï¼Ÿ')){
localStorage.removeItem('gdq_user');
location.reload();
}
}

function doSend(){
var input = document.getElementById('msg-input');
var content = input.value.trim();
if(!content) return;

if(!currentUser){alert('è¯·å…ˆç™»å½•');return;}

// æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
aiHistory.push({role:'user',content:content});
renderMessages();
input.value = '';

// æ·»åŠ æ€è€ƒä¸­
var msgs = document.getElementById('messages');
msgs.innerHTML += '<div class="message ai" id="typing"><div class="message-avatar">ğŸŸ</div><div class="message-content"><div class="message-bubble"><span class="typing">æ­£åœ¨æ€è€ƒ...</span></div></div></div>';
msgs.scrollTop = msgs.scrollHeight;

// è°ƒç”¨AI
var fd = new FormData();
fd.append('user_id', currentUser.id);
fd.append('message', content);

fetch('/ai-chat/api/ai.php?action=chat',{method:'POST',body:fd})
.then(r => r.json())
.then(d => {
if(d.code === 1){
aiHistory.push({role:'assistant',content:d.data.reply});
renderMessages();
}else{
document.getElementById('typing').remove();
alert('AIå“åº”å¤±è´¥: ' + (d.msg||''));
}
})
.catch(e => {
document.getElementById('typing').remove();
alert('è¯·æ±‚å¤±è´¥');
});
}

function renderMessages(){
var html = '';
aiHistory.forEach(h => {
var isMine = h.role === 'user';
html += '<div class="message ' + (isMine ? 'mine' : 'ai') + '">' +
'<div class="message-avatar">' + (isMine ? 'ğŸ‘¤' : 'ğŸŸ') + '</div>' +
'<div class="message-content"><div class="message-bubble">' + h.content + '</div></div></div>';
});
document.getElementById('messages').innerHTML = html;
document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}
</script>
</body>
</html>
