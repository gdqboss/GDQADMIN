<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å½©ç¾ç‰¹ AI èŠå¤©</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,sans-serif;background:#f5f7fa;height:100vh}
#login-page{display:flex;align-items:center;justify-content:center;height:100vh}
.login-box{background:white;padding:30px;border-radius:16px;width:90%;max-width:350px;box-shadow:0 4px 20px}
#chat-page{display:none;height:100vh;flex-direction:column}
.chat-header{padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:space-between}
.chat-header h3{margin:0;font-size:18px}
.chat-messages{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa}
.message{display:flex;margin-bottom:15px}
.message.mine{flex-direction:row-reverse}
.message-avatar{width:36px;height:36px;border-radius:50%;background:#667eea;color:white;display:flex;align-items:center;justify-content:center;margin:0 10px;flex-shrink:0}
.message.mine .message-avatar{background:#4caf50}
.message-content{max-width:75%}
.message-bubble{padding:10px 15px;border-radius:16px;background:white;box-shadow:0 1px 3px;word-break:break-word}
.message.mine .message-bubble{background:#667eea;color:white}
.message.ai .message-avatar{linear-gradient(135deg,#f093fb,#f5576c)}
.message.ai .message-bubble{background:#fef3c7}
.chat-input{padding:15px;background:white;display:flex;gap:10px;border-top:1px solid #eee}
.chat-input input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:24px;outline:none}
.chat-input button{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:24px;cursor:pointer}
.btn{background:#667eea;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;margin:5px}
.btn-secondary{background:#666}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal-content{background:white;border-radius:16px;padding:20px;width:90%;max-width:400px}
</style>
</head>
<body>
<div id="login-page">
<div class="login-box">
<h3 style="text-align:center;margin-bottom:20px">ğŸŸ å½©ç¾ç‰¹ AI èŠå¤©</h3>
<input type="text" id="username" class="form-control mb-2" placeholder="ç”¨æˆ·å">
<input type="password" id="password" class="form-control mb-3" placeholder="å¯†ç ">
<button class="btn w-100" onclick="doLogin()">ç™»å½•</button>
<p style="text-align:center;margin-top:10px"><a href="#" onclick="showInvite()">ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ</a></p>
</div>
</div>

<!-- é‚€è¯·æ³¨å†Œå¼¹çª— -->
<div id="invite-modal" class="modal">
<div class="modal-content">
<h4>é‚€è¯·æ³¨å†Œ</h4>
<input type="text" id="invite-code" class="form-control mb-2" placeholder="é‚€è¯·ç ">
<input type="text" id="reg-username" class="form-control mb-2" placeholder="ç”¨æˆ·å">
<input type="text" id="reg-nickname" class="form-control mb-2" placeholder="æ˜µç§°">
<input type="password" id="reg-password" class="form-control mb-2" placeholder="å¯†ç ">
<button class="btn" onclick="registerWithInvite()">æ³¨å†Œ</button>
<button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
</div>
</div>

<div id="chat-page">
<div class="chat-header">
<h3>ğŸŸ æ±Ÿå°é±¼ AIåŠ©æ‰‹</h3>
<div>
<button onclick="showMyStaff()" style="background:none;border:none;color:white;font-size:14px;margin-right:10px">ğŸ‘¥ å‘˜å·¥</button>
<button onclick="createInvite()" style="background:none;border:none;color:white;font-size:14px">â• é‚€è¯·</button>
</div>
</div>
<div class="chat-messages" id="messages"></div>
<div class="chat-input">
<input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')doSend()">
<button onclick="doSend()">å‘é€</button>
</div>
</div>

<!-- å‘˜å·¥åˆ—è¡¨å¼¹çª— -->
<div id="staff-modal" class="modal">
<div class="modal-content">
<h4>æˆ‘çš„å‘˜å·¥</h4>
<div id="staff-list"></div>
<button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
</div>
</div>

<!-- é‚€è¯·ç å¼¹çª— -->
<div id="invite-result-modal" class="modal">
<div class="modal-content">
<h4>é‚€è¯·é“¾æ¥</h4>
<p id="invite-link" style="word-break:break-all;font-size:14px;color:#666"></p>
<button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
</div>
</div>

<script>
var currentUser = null;
var memory_file = '/tmp/gdq_shared_memory.json';

var saved = localStorage.getItem('gdq_user');
if(saved){
currentUser = JSON.parse(saved);
showChat();
loadMemory();
}

function doLogin(){
var u = document.getElementById('username').value.trim();
var p = document.getElementById('password').value;
if(!u||!p){alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}
var fd = new FormData();
fd.append('username',u);fd.append('password',p);
fetch('/ai-chat/api/user.php?action=login',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
if(d.code===1){
currentUser = d.data;
localStorage.setItem('gdq_user',JSON.stringify(currentUser));
showChat();
loadMemory();
}else{alert(d.msg);}
});
}

function showChat(){
document.getElementById('login-page').style.display='none';
document.getElementById('chat-page').style.display='flex';
document.getElementById('msg-input').focus();
}

// åŠ è½½å…±äº«è®°å¿†
function loadMemory(){
fetch('/ai-chat/api/ai.php?action=memory')
.then(r=>r.json()).then(d=>{
if(d.code===1 && d.data.length>0){
renderMemory(d.data);
}else{
document.getElementById('messages').innerHTML='<div style="text-align:center;color:#888;padding:50px"><div style="font-size:48px">ğŸŸ</div><div>ä½ å¥½ï¼æˆ‘æ˜¯æ±Ÿå°é±¼</div></div>';
}
});
}

function renderMemory(data){
var html='';
data.forEach(m=>{
var isMine=m.role==='user';
html+='<div class="message '+(isMine?'mine':'ai')+'">'+
'<div class="message-avatar">'+(isMine?'ğŸ‘¤':'ğŸŸ')+'</div>'+
'<div class="message-content"><div class="message-bubble">'+m.content+'</div></div></div>';
});
document.getElementById('messages').innerHTML=html;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

function doSend(){
var input=document.getElementById('msg-input');
var content=input.value.trim();
if(!content)return;
if(!currentUser){alert('è¯·å…ˆç™»å½•');return;}

// æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
var html='<div class="message mine"><div class="message-avatar">ğŸ‘¤</div><div class="message-content"><div class="message-bubble">'+content+'</div></div></div>';
document.getElementById('messages').innerHTML+=html;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
input.value='';

// è°ƒç”¨AI
var fd=new FormData();
fd.append('user_id',currentUser.id);
fd.append('username',currentUser.nickname||currentUser.username);
fd.append('message',content);

fetch('/ai-chat/api/ai.php?action=chat',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
if(d.code===1){
var replyHtml='<div class="message ai"><div class="message-avatar">ğŸŸ</div><div class="message-content"><div class="message-bubble">'+d.data.reply+'</div></div></div>';
document.getElementById('messages').innerHTML+=replyHtml;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}
});
}

// é‚€è¯·åŠŸèƒ½
function showInvite(){
var code=new URLSearchParams(window.location.search).get('invite');
if(code){
document.getElementById('invite-code').value=code;
}
document.getElementById('invite-modal').classList.add('show');
}

function registerWithInvite(){
var code=document.getElementById('invite-code').value.trim();
var u=document.getElementById('reg-username').value.trim();
var n=document.getElementById('reg-nickname').value.trim()||u;
var p=document.getElementById('reg-password').value;
if(!code||!u||!p){alert('è¯·å¡«å†™å®Œæ•´');return;}
var fd=new FormData();
fd.append('invite_code',code);
fd.append('username',u);
fd.append('nickname',n);
fd.append('password',p);
fetch('/ai-chat/api/invite.php?action=register_with_invite',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
alert(d.msg);
if(d.code===1){closeModal();location.href='/ai-chat/';}
});
}

function createInvite(){
if(!currentUser){alert('è¯·å…ˆç™»å½•');return;}
var fd=new FormData();
fd.append('inviter_id',currentUser.id);
fetch('/ai-chat/api/invite.php?action=create_invite',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
if(d.code===1){
document.getElementById('invite-link').textContent=d.data.link;
document.getElementById('invite-result-modal').classList.add('show');
}
});
}

function showMyStaff(){
if(!currentUser){alert('è¯·å…ˆç™»å½•');return;}
fetch('/ai-chat/api/invite.php?action=my_staff&owner_id='+currentUser.id)
.then(r=>r.json()).then(d=>{
if(d.code===1){
var html=d.data.length?'':'æš‚æ— å‘˜å·¥';
d.data.forEach(s=>{html+='<div style="padding:10px;border-bottom:1px solid:#eee">'+(s.nickname||s.username)+'</div>';});
document.getElementById('staff-list').innerHTML=html;
document.getElementById('staff-modal').classList.add('show');
}
});
}

function closeModal(){
document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));
}
</script>
</body>
</html>
