<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>å½©ç¾ç‰¹ AI èŠå¤©å®¤</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; }

#login-page { display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); }
.login-box { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.login-box h3 { text-align: center; margin-bottom: 30px; }

#chat-page { display: none; height: 100vh; flex-direction: column; }

.chat-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.chat-header .left { display: flex; align-items: center; gap: 10px; }
.chat-header .menu-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }
.chat-header .home-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 15px; font-size: 14px; text-decoration: none; }

.sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; z-index: 100; transition: left 0.3s; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
.sidebar.show { left: 0; }
.sidebar-header { padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.sidebar-menu { flex: 1; overflow-y: auto; }
.sidebar-menu a { display: block; padding: 15px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #f0f0f0; }
.sidebar-menu a:hover { background: #f5f5f5; }

.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; }
.overlay.show { display: block; }

.chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f0f2f5; }

.message { display: flex; margin-bottom: 12px; align-items: flex-start; position: relative; }
.message:hover .msg-actions { display: flex; }
.message.mine { flex-direction: row-reverse; }

.message-avatar { width: 36px; height: 36px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; margin: 0 10px; }
.message.mine .message-avatar { background: #4caf50; }
.message.ai .message-avatar { background: linear-gradient(135deg, #f093fb, #f5576c); }

.message-content { max-width: 75%; position: relative; }
.message-bubble { padding: 10px 16px; border-radius: 16px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; line-height: 1.5; position: relative; }
.message.mine .message-bubble { background: #667eea; color: white; border-bottom-right-radius: 4px; }
.message:not(.mine) .message-bubble { border-bottom-left-radius: 4px; }

/* å›å¤æ ·å¼ */
.reply-to { background: rgba(0,0,0,0.05); padding: 8px 12px; margin: -10px -16px 10px -16px; border-radius: 12px 12px 0 0; font-size: 12px; color: #666; border-bottom: 1px solid rgba(0,0,0,0.1); }
.message.mine .reply-to { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }

/* å›¾ç‰‡æ¶ˆæ¯ */
.msg-image { max-width: 200px; border-radius: 12px; margin-top: 5px; cursor: pointer; }
.msg-image:hover { opacity: 0.9; }

/* æ–‡ä»¶æ¶ˆæ¯ */
.msg-file { display: flex; align-items: center; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 10px; margin-top: 5px; cursor: pointer; }
.msg-file-icon { font-size: 24px; margin-right: 10px; }
.msg-file-info { flex: 1; }
.msg-file-name { font-size: 13px; font-weight: 500; }
.msg-file-size { font-size: 11px; color: #888; }
.message.mine .msg-file { background: rgba(255,255,255,0.2); }
.message.mine .msg-file-info { color: white; }
.message.mine .msg-file-size { color: rgba(255,255,255,0.7); }

/* æ¶ˆæ¯æ“ä½œæŒ‰é’® */
.msg-actions { display: none; position: absolute; top: -10px; right: -10px; background: white; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 2px; z-index: 10; }
.message.mine .msg-actions { right: auto; left: -10px; }
.msg-action-btn { background: none; border: none; padding: 6px 10px; font-size: 14px; cursor: pointer; border-radius: 15px; }
.msg-action-btn:hover { background: #f0f0f0; }

/* è¾“å…¥åŒºåŸŸ */
.chat-input { background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #eee; flex-shrink: 0; }
.chat-input input[type="text"] { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 24px; outline: none; font-size: 15px; }
.chat-input input[type="text"]:focus { border-color: #667eea; }
.chat-input button { padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 24px; font-size: 15px; cursor: pointer; }
.chat-input button:active { background: #5568d3; }
.chat-input .attach-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; color: #666; }
.chat-input .attach-btn:hover { color: #667eea; }

.reply-bar { display: none; padding: 8px 15px; background: #f8f9fa; border-top: 1px solid #eee; font-size: 13px; color: #666; }
.reply-bar.show { display: flex; align-items: center; }
.reply-bar .close { margin-left: auto; cursor: pointer; color: #999; }

.welcome { text-align: center; padding: 60px 20px; color: #666; }
.welcome-icon { font-size: 64px; margin-bottom: 20px; }
.welcome h2 { font-size: 20px; color: #333; margin-bottom: 10px; }

@media (min-width: 768px) {
    .sidebar { position: relative; left: 0; width: 260px; flex-shrink: 0; }
    .chat-page { flex-direction: row; }
    .chat-header { display: none; }
    .overlay { display: none !important; }
    .message-content { max-width: 60%; }
}
@media (max-width: 767px) {
    .message-content { max-width: 80%; }
}
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 16px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
.modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
.modal-body { padding: 20px; }
</style>
</head>
<body>

<div id="login-page">
<div class="login-box">
<h3>ğŸŸ å½©ç¾ç‰¹ AI èŠå¤©å®¤</h3>
<input type="text" id="username" placeholder="ç”¨æˆ·å" style="width:100%;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px">
<input type="password" id="password" placeholder="å¯†ç " style="width:100%;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:15px">
<button onclick="doLogin()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:16px;cursor:pointer">ç™»å½•</button>
<p style="text-align:center;margin-top:15px;font-size:13px;color:#888">æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showRegister()" style="color:#667eea;text-decoration:none">æ³¨å†Œ</a></p>
</div>
</div>

<div id="chat-page">
<div class="chat-header">
<div class="left">
<button class="menu-btn" onclick="toggleMenu()">â˜°</button>
<h3>ğŸŸ AI èŠå¤©å®¤</h3>
</div>
<a href="/" class="home-btn">ğŸ  ä¸»é¡µ</a>
</div>

<div class="overlay" onclick="toggleMenu()"></div>
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
<div style="font-size:16px;font-weight:600">ğŸŸ å½©ç¾ç‰¹</div>
<div style="font-size:12px;margin-top:5px;opacity:0.8" id="user-display"></div>
</div>
<div class="sidebar-menu">
<a href="#" class="active" onclick="clearMemory()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</a>
<a href="#" onclick="showSettings()">âš™ï¸ èŠå¤©å®¤è®¾ç½®</a>
<hr style="margin:10px 0;border:none;border-top:1px solid #eee">
<a href="/" style="color:#666">ğŸ  è¿”å›ä¸»é¡µ</a>
</div>
</div>

<div class="chat-messages" id="messages">
<div class="welcome">
<div class="welcome-icon">ğŸŸ</div>
<h2>æ¬¢è¿æ¥åˆ°å½©ç¾ç‰¹ AI èŠå¤©å®¤</h2>
<p>å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯ï¼Œæ”¯æŒå›å¤ã€å¤åˆ¶ã€å›¾ç‰‡</p>
</div>
</div>

<!-- å›å¤æ  -->
<div class="reply-bar" id="reply-bar">
<span>å›å¤: <b id="reply-content"></b></span>
<span class="close" onclick="cancelReply()">âœ•</span>
</div>

<!-- è¾“å…¥åŒº -->
<div class="chat-input">
<button class="attach-btn" onclick="document.getElementById('file-input').click()">ğŸ“</button>
<input type="file" id="file-input" style="display:none" onchange="handleFile(this)">
<input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')doSend()">
<button onclick="doSend()">å‘é€</button>
</div>
</div>

<div id="register-modal" class="modal">
<div class="modal-content">
<div class="modal-header"><span style="font-weight:600">æ³¨å†Œ</span><span onclick="closeModal('register')" style="font-size:24px;cursor:pointer">Ã—</span></div>
<div class="modal-body">
<input type="text" id="reg-username" placeholder="ç”¨æˆ·å" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
<input type="text" id="reg-nickname" placeholder="æ˜µç§°" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
<input type="password" id="reg-password" placeholder="å¯†ç " style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
<button onclick="register()" style="width:100%;padding:12px;background:#667eea;color:white;border:none;border-radius:10px">æ³¨å†Œ</button>
</div>
</div>
</div>

<script>
var currentUser = null;
var replyTo = null;
var memory_file = '/tmp/gdq_shared_memory.json';

var saved = localStorage.getItem('gdq_user');
if(saved){currentUser=JSON.parse(saved);showChat();loadHistory();}

var urlParams = new URLSearchParams(window.location.search);
if(urlParams.get('invite')){document.getElementById('register-modal').classList.add('show');}

function doLogin(){
var u=document.getElementById('username').value.trim();
var p=document.getElementById('password').value;
if(!u||!p){alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}
var fd=new FormData();
fd.append('username',u);fd.append('password',p);
fetch('/ai-chat/api/user.php?action=login',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
if(d.code===1){
currentUser=d.data;
localStorage.setItem('gdq_user',JSON.stringify(currentUser));
showChat();loadHistory();
}else{alert(d.msg);}
});
}

function showChat(){
document.getElementById('login-page').style.display='none';
document.getElementById('chat-page').style.display='flex';
document.getElementById('user-display').textContent=currentUser.nickname||currentUser.username;
document.getElementById('msg-input').focus();
}

function loadHistory(){
fetch('/ai-chat/api/realtime.php?action=history')
.then(r=>r.json()).then(d=>{
if(d.code===1 && d.data.length>0){renderMessages(d.data);}
});
}

function renderMessages(data){
var html='';
data.forEach(function(m,i){
var isMine=m.role==='user';
var avatar=isMine?'ğŸ‘¤':(m.source&&m.source.indexOf('external')>=0?'ğŸ¤–':'ğŸŸ');
var bubbleClass=isMine?'mine':(m.source&&(m.source.indexOf('telegram')>=0||m.source.indexOf('external')>=0)?'ai':'');
var content=m.content;
var extra='';

// å¤„ç†å›¾ç‰‡
if(m.type==='image'){
extra='<img src="'+m.content+'" class="msg-image" onclick="previewImage(\''+m.content+'\')">';
}
// å¤„ç†æ–‡ä»¶
else if(m.type==='file'){
var fileInfo=JSON.parse(m.content||'{}');
extra='<div class="msg-file" onclick="downloadFile(\''+fileInfo.url+'\')"><div class="msg-file-icon">ğŸ“„</div><div class="msg-file-info"><div class="msg-file-name">'+(fileInfo.name||'æ–‡ä»¶')+'</div><div class="msg-file-size">'+(fileInfo.size||'')+'</div></div></div>';
}
// å›å¤
else if(m.reply_to){
content='<div class="reply-to">å›å¤: '+m.reply_to+'</div>'+m.content;
}

html+='<div class="message '+bubbleClass+'" data-id="'+i+'">'+
'<div class="message-avatar">'+avatar+'</div>'+
'<div class="message-content">'+
'<div class="message-bubble">'+content+extra+'</div>'+
'<div class="msg-actions">'+
'<button class="msg-action-btn" onclick="replyMessage(\''+m.content.substring(0,30)+'\')" title="å›å¤">â†©ï¸</button>'+
'<button class="msg-action-btn" onclick="copyMessage(\''+encodeURIComponent(m.content)+'\')" title="å¤åˆ¶">ğŸ“‹</button>'+
'</div></div></div>';
});
document.getElementById('messages').innerHTML=html||'<div class="welcome"><div class="welcome-icon">ğŸŸ</div><h2>å¼€å§‹å¯¹è¯å§</h2></div>';
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

function doSend(){
var input=document.getElementById('msg-input');
var content=input.value.trim();
if(!content||!currentUser)return;

// æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
var replyHtml=replyTo?'<div class="reply-to">å›å¤: '+replyTo+'</div>':'';
var html='<div class="message mine"><div class="message-avatar">ğŸ‘¤</div><div class="message-content"><div class="message-bubble">'+replyHtml+content+'</div></div></div>';
document.getElementById('messages').innerHTML+=html;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
input.value='';
cancelReply();

// è°ƒç”¨AI
var fd=new FormData();
fd.append('user_id',currentUser.id);
fd.append('username',currentUser.nickname||currentUser.username);
fd.append('message',content);

fetch('/ai-chat/api/realtime.php?action=chat',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{
if(d.code===1){
var replyHtml='<div class="message ai"><div class="message-avatar">ğŸŸ</div><div class="message-content"><div class="message-bubble">'+d.data.reply+'</div></div></div>';
document.getElementById('messages').innerHTML+=replyHtml;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}
});
}

// å›å¤åŠŸèƒ½
function replyMessage(text){
replyTo=text.substring(0,50);
document.getElementById('reply-content').textContent=text;
document.getElementById('reply-bar').classList.add('show');
document.getElementById('msg-input').focus();
}

function cancelReply(){
replyTo=null;
document.getElementById('reply-bar').classList.remove('show');
}

// å¤åˆ¶åŠŸèƒ½
function copyMessage(text){
try{
navigator.clipboard.writeText(decodeURIComponent(text));
alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}catch(e){
alert('å¤åˆ¶å¤±è´¥');
}
}

// æ–‡ä»¶/å›¾ç‰‡ä¸Šä¼ 
function handleFile(input){
var file=input.files[0];
if(!file)return;

var fd=new FormData();
fd.append('file',file);

document.getElementById('msg-input').value='ä¸Šä¼ ä¸­...';

fetch('/ai-chat/api/upload.php',{method:'POST',body:fd})
.then(r=>r.json())
.then(d=>{
if(d.code===1){
var url=d.data.url;
var type=d.data.type;
var isImage=type&&type.indexOf('image')>=0;
var display=isImage?'<img src="'+url+'" class="msg-image">':'<div class="msg-file"><div class="msg-file-icon">ğŸ“„</div><div class="msg-file-info"><div class="msg-file-name">'+file.name+'</div></div></div>';
var html='<div class="message mine"><div class="message-avatar">ğŸ‘¤</div><div class="message-content"><div class="message-bubble">'+display+'</div></div></div>';
document.getElementById('messages').innerHTML+=html;
document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}
document.getElementById('msg-input').value='';
input.value='';
});
}

function toggleMenu(){
document.getElementById('sidebar').classList.toggle('show');
document.querySelector('.overlay').classList.toggle('show');
}

function showRegister(){document.getElementById('register-modal').classList.add('show');}
function closeModal(id){document.getElementById(id+'-modal').classList.remove('show');}

function register(){
var u=document.getElementById('reg-username').value.trim();
var n=document.getElementById('reg-nickname').value.trim()||u;
var p=document.getElementById('reg-password').value;
if(!u||!p){alert('è¯·å¡«å†™å®Œæ•´');return;}
var fd=new FormData();
fd.append('username',u);fd.append('nickname',n);fd.append('password',p);
fetch('/ai-chat/api/user.php?action=register',{method:'POST',body:fd})
.then(r=>r.json()).then(d=>{alert(d.msg);if(d.code===1){closeModal('register');doLogin();}});
}

function clearMemory(){
if(confirm('ç¡®å®šæ¸…ç©ºå¯¹è¯ï¼Ÿ')){
fetch('/ai-chat/api/realtime.php?action=clear')
.then(r=>r.json()).then(d=>{
document.getElementById('messages').innerHTML='<div class="welcome"><div class="welcome-icon">ğŸŸ</div><h2>å¯¹è¯å·²æ¸…ç©º</h2></div>';
});
}
}
</script>
</body>
</html>
