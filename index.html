<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æµ·é²œç¤¾å·¥ä½œå°</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; min-height: 100vh; }
        body { 
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        
        /* ç™»å½•é¡µ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        .login-card {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            padding: 40px 30px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo .icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }
        
        .login-logo h2 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .login-logo p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .login-form input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
        }
        
        .login-form button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }
        
        .login-form button:active {
            transform: scale(0.98);
        }
        
        .dingtalk-btn {
            width: 100%;
            padding: 12px;
            background: #07C160;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: #999;
        }
        
        /* é¦–é¡µ */
        .home-container {
            min-height: 100vh;
            background: #f5f6fa;
        }
        
        .home-header {
            background: linear-gradient(135deg, #0f0c29, #302b63);
            padding: 20px;
            color: white;
        }
        
        .user-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .user-info h5 {
            margin: 0;
            font-size: 18px;
        }
        
        .user-info p {
            margin: 4px 0 0;
            font-size: 13px;
            opacity: 0.8;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            margin-top: 15px;
        }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 15px;
        }
        
        .menu-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
            text-decoration: none;
            display: block;
        }
        
        .menu-card:active {
            transform: scale(0.98);
        }
        
        .menu-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .menu-card h6 {
            margin: 0;
            font-size: 14px;
            color: #333;
        }
        
        .menu-card p {
            margin: 4px 0 0;
            font-size: 11px;
            color: #999;
        }
        
        .lang-dropdown {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 100;
        }
        
        .lang-dropdown select {
            padding: 6px 12px;
            border-radius: 20px;
            border: none;
            background: rgba(255,255,255,0.9);
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 360px;
        }
        
        .modal h5 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal input, .modal select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .modal-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btns button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
        }
        
        .btn-cancel { background: #eee; color: #666; }
        .btn-save { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        
        .error-msg {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µ -->
    <div id="loginPage" class="login-container" style="display:none">
        <div class="login-card">
            <div class="login-logo">
                <div class="icon">ğŸ¦</div>
                <h2 id="titleText">æµ·é²œç¤¾</h2>
                <p id="subtitleText">ä¼ä¸šå·¥ä½œå°</p>
            </div>
            
            <div id="loginError" class="error-msg"></div>
            
            <form class="login-form" id="loginForm">
                <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å">
                <input type="password" id="loginPassword" placeholder="å¯†ç ">
                <button type="submit" id="loginBtn">ç™»å½•</button>
            </form>
            
            <button class="dingtalk-btn" onclick="dingtalkLogin()" id="dingtalkBtn">
                <span>ğŸ“±</span> é’‰é’‰æ‰«ç ç™»å½•
            </button>
            
            <div class="login-footer" id="contactText">
                å¦‚éœ€å¼€é€šè´¦å·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜
            </div>
        </div>
    </div>
    
    <!-- é¦–é¡µ -->
    <div id="homePage" style="display:none">
        <div class="home-header">
            <div class="lang-dropdown">
                <select id="langSelect" onchange="changeLang(this.value)">
                    <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                    <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ JP</option>
                    <option value="ko">ğŸ‡°ğŸ‡· KR</option>
                    <option value="id">ğŸ‡®ğŸ‡© ID</option>
                    <option value="tl">ğŸ‡µğŸ‡­ PH</option>
                    <option value="vi">ğŸ‡»ğŸ‡³ VN</option>
                </select>
            </div>
            
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                <div class="user-info">
                    <h5 id="userName">ç”¨æˆ·</h5>
                    <p id="userDept">éƒ¨é—¨</p>
                    <p id="userCompany">æµ·é²œç¤¾</p>
                </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px">
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                <button class="logout-btn" onclick="showProfile()" style="background:rgba(255,255,255,0.1)">ğŸ‘¤ èµ„æ–™</button>
            </div>
        </div>
        
        <div class="menu-grid">
            <a href="/commune/chat.html" class="menu-card">
                <div class="menu-icon" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">ğŸ’¬</div>
                <h6 id="menuChat1">èŠå¤©å®¤</h6>
                <p>å›¢é˜Ÿæ²Ÿé€š</p>
            </a>
            
            <a href="/qrcode_stats.html" class="menu-card">
                <div class="menu-icon" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">ğŸ·ï¸</div>
                <h6 id="menuQrcode1">ä¸€ç‰©ä¸€ç </h6>
                <p>è¿½æº¯ç³»ç»Ÿ</p>
            </a>
            
            <a href="/inventory_stats.html" class="menu-card">
                <div class="menu-icon" style="background: linear-gradient(135deg, #fce4ec, #f8bbd9);">ğŸ“¦</div>
                <h6 id="menuInventory1">è¿›é”€å­˜</h6>
                <p>åº“å­˜ç®¡ç†</p>
            </a>
            
            <a href="/commune/admin.html" class="menu-card" id="adminLink" style="display:none">
                <div class="menu-icon" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7);">âš™ï¸</div>
                <h6 id="menuAdmin1">ç®¡ç†åå°</h6>
                <p>ç³»ç»Ÿç®¡ç†</p>
            </a>
        </div>
        
        <!-- ç­¾åˆ°å’Œæ—¥å¿— -->
<!-- ç­¾åˆ°å’Œæ—¥å¿—ç»„ä»¶ -->
<div style="padding:15px">
    <div style="display:flex;gap:8px;margin-bottom:12px">
        <div onclick="togglePanel('checkin')" id="checkinTabBtn" style="flex:1;text-align:center;padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:white;cursor:pointer;font-size:12px">
            <div style="font-size:18px" id="checkInIcon">ğŸ“Œ</div>
            <div id="checkInText">ç­¾åˆ°</div>
        </div>
        <div onclick="togglePanel('worklog')" id="worklogTabBtn" style="flex:1;text-align:center;padding:10px;background:linear-gradient(135deg,#4caf50,#2e7d32);border-radius:8px;color:white;cursor:pointer;font-size:12px">
            <div style="font-size:18px">ğŸ“</div>
            <div>æ—¥å¿—</div>
        </div>
        <div onclick="togglePanel('stats')" id="statsTabBtn" style="flex:1;text-align:center;padding:10px;background:linear-gradient(135deg,#ff9800,#ff5722);border-radius:8px;color:white;cursor:pointer;font-size:12px">
            <div style="font-size:18px">ğŸ“Š</div>
            <div>ç»Ÿè®¡</div>
        </div>
    </div>
    
    <!-- ç­¾åˆ°é¢æ¿ -->
    <div id="checkinPanel" style="display:none;background:white;border-radius:10px;padding:15px;margin-bottom:10px">
        <div id="checkinStatusArea" style="text-align:center;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;color:white;margin-bottom:15px">
            <div id="checkStatusIcon" style="font-size:36px">ğŸ“Œ</div>
            <div id="checkStatusText" style="font-weight:600;margin:8px 0">ç‚¹å‡»ç­¾åˆ°</div>
            <div id="checkTimeText" style="font-size:12px;opacity:0.9"></div>
        </div>
        
        <!-- ç­¾åˆ°è¡¨å• -->
        <div id="checkinForm">
            <div style="text-align:center;padding:15px;background:#e8f5e9;border-radius:10px;margin-bottom:15px">
                <button onclick="getLocation()" id="getLocationBtn" style="padding:10px 20px;background:#4caf50;color:white;border:none;border-radius:20px;font-size:13px;cursor:pointer">ğŸ“ è·å–å½“å‰ä½ç½®</button>
                <div id="locationStatus" style="font-size:12px;color:#666;margin-top:8px"></div>
                <input type="hidden" id="checkLat">
                <input type="hidden" id="checkLng">
            </div>
            <div style="text-align:center;padding:10px;background:#fff3e0;border-radius:8px;margin-bottom:15px;font-size:13px;color:#e65100">
                ğŸ“ <span id="checkinNote">è¯·å®Œæˆç­¾åˆ°</span>
            </div>
            <textarea id="checkRemark" placeholder="ç­¾åˆ°å¤‡æ³¨ (å¯é€‰)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:10px;font-size:13px;height:50px;resize:none"></textarea>
            <button onclick="submitCheckIn()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer">ç¡®è®¤ç­¾åˆ°</button>
        </div>
        
        <div style="margin-top:15px;font-weight:600;font-size:13px;border-top:1px solid #eee;padding-top:10px">ğŸ“… ç­¾åˆ°è®°å½•</div>
        <div id="checkInList" style="font-size:12px;color:#666;margin-top:8px;max-height:120px;overflow-y:auto"></div>
    </div>
    
    <!-- æ—¥å¿—é¢æ¿ -->
    <div id="worklogPanel" style="display:none;background:white;border-radius:10px;padding:12px;margin-bottom:10px">
        <div style="display:flex;gap:5px;margin-bottom:10px;overflow-x:auto" id="logTypeTabs">
            <button onclick="selectLogType('daily')" class="log-type-btn active" data-type="daily" style="padding:5px 10px;border:1px solid #ddd;background:#4caf50;color:white;border-radius:15px;font-size:11px">æ—¥æŠ¥</button>
            <button onclick="selectLogType('weekly')" class="log-type-btn" data-type="weekly" style="padding:5px 10px;border:1px solid #ddd;background:white;border-radius:15px;font-size:11px">å‘¨æŠ¥</button>
            <button onclick="selectLogType('project')" class="log-type-btn" data-type="project" style="padding:5px 10px;border:1px solid #ddd;background:white;border-radius:15px;font-size:11px">é¡¹ç›®</button>
            <button onclick="selectLogType('meeting')" class="log-type-btn" data-type="meeting" style="padding:5px 10px;border:1px solid #ddd;background:white;border-radius:15px;font-size:11px">ä¼šè®®</button>
        </div>
        <button onclick="showAddLog()" style="width:100%;padding:10px;background:#4caf50;color:white;border:none;border-radius:8px;font-size:13px;cursor:pointer;margin-bottom:10px">â• å†™æ—¥å¿—</button>
        <div id="workLogList" style="max-height:150px;overflow-y:auto;font-size:12px"></div>
    </div>
    
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="statsPanel" style="display:none;background:white;border-radius:10px;padding:15px;margin-bottom:10px">
        <div style="font-weight:600;font-size:14px;margin-bottom:15px">ğŸ“Š ç­¾åˆ°ç»Ÿè®¡</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px">
            <div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:8px">
                <div id="statToday" style="font-size:20px;font-weight:bold;color:#667eea">0</div>
                <div style="font-size:11px;color:#666">ä»Šæ—¥</div>
            </div>
            <div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:8px">
                <div id="statWeek" style="font-size:20px;font-weight:bold;color:#4caf50">0</div>
                <div style="font-size:11px;color:#666">æœ¬å‘¨</div>
            </div>
            <div style="text-align:center;padding:12px;background:#f8f9fa;border-radius:8px">
                <div id="statMonth" style="font-size:20px;font-weight:bold;color:#ff9800">0</div>
                <div style="font-size:11px;color:#666">æœ¬æœˆ</div>
            </div>
        </div>
        <div style="font-weight:600;font-size:14px;margin-bottom:15px">ğŸ“ æ—¥å¿—ç»Ÿè®¡</div>
        <div style="text-align:center;padding:15px;background:#f8f9fa;border-radius:8px">
            <div id="logStatCount" style="font-size:24px;font-weight:bold;color:#4caf50">0</div>
            <div style="font-size:11px;color:#666">ä»Šæ—¥æ—¥å¿—</div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
var currentLogType = 'daily';
var currentUser = {id: 1, name: 'ç”¨æˆ·'};
var currentCheckinLocation = '';

// åˆå§‹åŒ–
function initAttendance() {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    try {
        var stored = localStorage.getItem('commune_user');
        if (stored) {
            var user = JSON.parse(stored);
            currentUser = {id: user.id || 1, name: user.nickname || user.username || 'ç”¨æˆ·'};
        }
    } catch(e) {}
    
    // åŠ è½½ç­¾åˆ°é…ç½®
    loadCheckinConfig();
    
    // æ£€æŸ¥ä»Šæ—¥ç­¾åˆ°çŠ¶æ€
    checkTodayStatus();
}

// åŠ è½½ç­¾åˆ°é…ç½®
function loadCheckinConfig() {
    fetch('/api/commune/attendance.php?action=get_config')
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1) {
            document.getElementById('checkinPlace').textContent = d.data.checkin_location || 'æœªè®¾ç½®';
            document.getElementById('checkinNote').textContent = d.data.checkin_remark || 'è¯·å®Œæˆç­¾åˆ°';
            currentCheckinLocation = d.data.checkin_location || '';
        }
    });
}

// åˆ‡æ¢é¢æ¿
function togglePanel(panel) {
    // æ›´æ–°tabæ ·å¼
    document.querySelectorAll('[id$="TabBtn"]').forEach(function(btn) {
        btn.style.opacity = '0.7';
    });
    document.getElementById(panel + 'TabBtn').style.opacity = '1';
    
    // æ˜¾ç¤º/éšè—é¢æ¿
    document.getElementById('checkinPanel').style.display = panel === 'checkin' ? 'block' : 'none';
    document.getElementById('worklogPanel').style.display = panel === 'worklog' ? 'block' : 'none';
    document.getElementById('statsPanel').style.display = panel === 'stats' ? 'block' : 'none';
    
    // åŠ è½½æ•°æ®
    if (panel === 'checkin') loadCheckIn();
    else if (panel === 'worklog') loadWorkLog();
    else if (panel === 'stats') loadStats();
}

// æ£€æŸ¥ä»Šæ—¥ç­¾åˆ°çŠ¶æ€
function checkTodayStatus() {
    fetch('/api/commune/attendance.php?action=today_status&user_id=' + currentUser.id + '&user_name=' + encodeURIComponent(currentUser.name))
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1 && d.data.checked) {
            document.getElementById('checkInIcon').textContent = 'âœ…';
            document.getElementById('checkInText').textContent = 'å·²ç­¾åˆ°';
        }
    })
    .catch(function(e) { console.error(e); });
}

// åŠ è½½ç­¾åˆ°æ•°æ®
function loadCheckIn() {
    fetch('/api/commune/attendance.php?action=today_status&user_id=' + currentUser.id + '&user_name=' + encodeURIComponent(currentUser.name))
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1) {
            if (d.data.checked) {
                document.getElementById('checkStatusIcon').textContent = 'âœ…';
                document.getElementById('checkStatusText').textContent = 'å·²ç­¾åˆ°';
                document.getElementById('checkTimeText').textContent = d.data.time;
                document.getElementById('checkinForm').style.display = 'none';
            } else {
                document.getElementById('checkStatusIcon').textContent = 'ğŸ“Œ';
                document.getElementById('checkStatusText').textContent = 'ç‚¹å‡»ç­¾åˆ°';
                document.getElementById('checkTimeText').textContent = '';
                document.getElementById('checkinForm').style.display = 'block';
            }
        }
    });
    
    // åŠ è½½ç­¾åˆ°è®°å½•
    fetch('/api/commune/attendance.php?action=attendance_list&user_id=' + currentUser.id + '&limit=10')
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1) {
            var html = '';
            d.data.forEach(function(item) {
                var loc = item.location ? ' ğŸ“' + item.location : '';
                var remark = item.remark ? ' - ' + item.remark : '';
                html += '<div style="padding:6px 8px;background:#f8f9fa;border-radius:4px;margin-bottom:6px"><div style="font-weight:500">' + item.user_name + '</div><div style="font-size:10px;color:#666">' + item.check_date + ' ' + item.check_time + loc + remark + '</div></div>';
            });
            document.getElementById('checkInList').innerHTML = html || '<div style="color:#999;text-align:center;padding:10px">æš‚æ— è®°å½•</div>';
        }
    });
}

// è·å–ä½ç½® - ä¼˜åŒ–ç‰ˆ
function getLocation() {
    var btn = document.getElementById('getLocationBtn');
    var status = document.getElementById('locationStatus');
    
    if (!navigator.geolocation) {
        status.innerHTML = 'âŒ ä¸æ”¯æŒå®šä½';
        return;
    }
    
    status.innerHTML = 'ğŸ”„ å®šä½ä¸­...';
    btn.disabled = true;
    
    // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ä½ç½®ï¼ˆæ›´å¿«ï¼‰
    var cachedPos = localStorage.getItem('cached_location');
    if (cachedPos) {
        var cached = JSON.parse(cachedPos);
        // ç¼“å­˜å°äº5åˆ†é’Ÿç›´æ¥ä½¿ç”¨
        if (Date.now() - cached.time < 300000) {
            document.getElementById('checkLat').value = cached.lat;
            document.getElementById('checkLng').value = cached.lng;
            status.innerHTML = 'ğŸ“ ' + cached.lat.toFixed(4) + ', ' + cached.lng.toFixed(4);
            btn.innerHTML = 'âœ… å·²å®šä½';
            btn.style.background = '#4caf50';
            return;
        }
    }
    
    // å¿«é€Ÿå®šä½é€‰é¡¹
    var options = {
        enableHighAccuracy: false, // é™ä½ç²¾åº¦è¦æ±‚åŠ å¿«é€Ÿåº¦
        timeout: 5000,            // 5ç§’è¶…æ—¶
        maximumAge: 60000          // å…è®¸1åˆ†é’Ÿç¼“å­˜
    };
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            document.getElementById('checkLat').value = lat;
            document.getElementById('checkLng').value = lng;
            
            // ç¼“å­˜ä½ç½®
            localStorage.setItem('cached_location', JSON.stringify({lat: lat, lng: lng, time: Date.now()}));
            
            // è·å–åœ°å€åç§°
            fetch('/api/commune/attendance.php?action=reverse_geocode&lat=' + lat + '&lng=' + lng)
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.code === 1 && d.data.address) {
                    status.innerHTML = 'ğŸ“ ' + d.data.address;
                    document.getElementById('checkLocation').value = d.data.address;
                } else {
                    status.innerHTML = 'ğŸ“ ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
                }
            })
            .catch(function() {
                status.innerHTML = 'ğŸ“ ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
            });
            
            btn.innerHTML = 'âœ… å·²å®šä½';
            btn.style.background = '#4caf50';
        },
        function(error) {
            // å¤±è´¥åå°è¯•é«˜ç²¾åº¦å®šä½
            status.innerHTML = 'ğŸ”„ é‡è¯•ä¸­...';
            navigator.geolocation.getCurrentPosition(
                function(pos2) {
                    var lat = pos2.coords.latitude;
                    var lng = pos2.coords.longitude;
                    document.getElementById('checkLat').value = lat;
                    document.getElementById('checkLng').value = lng;
                    localStorage.setItem('cached_location', JSON.stringify({lat: lat, lng: lng, time: Date.now()}));
                    status.innerHTML = 'ğŸ“ ' + lat.toFixed(4) + ', ' + lng.toFixed(4);
                    btn.innerHTML = 'âœ… å·²å®šä½';
                    btn.style.background = '#4caf50';
                },
                function(e2) {
                    var msg = 'å®šä½å¤±è´¥';
                    switch(e2.code) { case 1: msg = 'âš ï¸ è¯·å¼€å¯å®šä½æƒé™'; break; case 2: msg = 'âš ï¸ ä½ç½®ä¸å¯ç”¨'; break; case 3: msg = 'âš ï¸ å®šä½è¶…æ—¶'; }
                    status.innerHTML = msg + ' <a href="#" onclick="getLocation()">é‡è¯•</a>';
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“ é‡æ–°å®šä½';
                    btn.style.background = '#4caf50';
                },
                {enableHighAccuracy: true, timeout: 10000}
            );
        },
        options
    );
}

// æäº¤ç­¾åˆ°
function submitCheckIn() {
    var location = document.getElementById('locationStatus').textContent.replace('âœ… ä½ç½®: ', '').replace('ğŸ“ ', '') || currentCheckinLocation;
    var remark = document.getElementById('checkRemark').value;
    
    var url = '/api/commune/attendance.php?action=check_in&user_id=' + (currentUser.id || 1) + '&user_name=' + encodeURIComponent(currentUser.name || 'ç”¨æˆ·') + '&location=' + encodeURIComponent(location) + '&remark=' + encodeURIComponent(remark);
    
    console.log('Checkin URL:', url);
    
    fetch(url)
    .then(function(r) { return r.text(); })
    .then(function(t) { 
        console.log('Response:', t); 
        try {
            var d = JSON.parse(t);
            alert(d.msg || 'ç­¾åˆ°' + (d.code === 1 ? 'æˆåŠŸ' : 'å¤±è´¥'));
            if (d.code === 1) {
                loadCheckIn();
                checkTodayStatus();
            }
        } catch(e) {
            alert('ç­¾åˆ°å®Œæˆ');
            loadCheckIn();
            checkTodayStatus();
        }
    })
    .catch(function(e) { 
        console.error(e); 
        alert('ç­¾åˆ°å¤±è´¥: ' + e); 
    });
}

// é€‰æ‹©æ—¥å¿—ç±»å‹
function selectLogType(type) {
    currentLogType = type;
    document.querySelectorAll('.log-type-btn').forEach(function(btn) {
        if (btn.dataset.type === type) {
            btn.style.background = '#4caf50';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.color = '#333';
        }
    });
    loadWorkLog();
}

// åŠ è½½æ—¥å¿—
function loadWorkLog() {
    fetch('/api/commune/attendance.php?action=log_list&user_id=' + currentUser.id + '&log_type=' + currentLogType + '&limit=10')
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1) {
            var html = '';
            var icons = {'daily':'ğŸ“‹','weekly':'ğŸ“…','project':'ğŸ“','meeting':'ğŸ‘¥','other':'ğŸ“'};
            d.data.forEach(function(item) {
                var icon = icons[item.log_type] || 'ğŸ“';
                html += '<div style="padding:8px;background:#f8f9fa;border-radius:6px;margin-bottom:6px"><div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:10px;color:#666"><span>' + icon + ' ' + item.user_name + '</span><span>' + item.log_date + '</span></div><div style="font-size:12px">' + item.content + '</div></div>';
            });
            document.getElementById('workLogList').innerHTML = html || '<div style="color:#999;text-align:center;padding:15px">æš‚æ— æ—¥å¿—</div>';
        }
    });
}

// æ˜¾ç¤ºæ·»åŠ æ—¥å¿—


// åŠ è½½ç»Ÿè®¡
function loadStats() {
    fetch('/api/commune/attendance.php?action=attendance_list&user_id=' + currentUser.id + '&limit=100')
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1 && d.stats) {
            document.getElementById('statToday').textContent = d.stats.today || 0;
            document.getElementById('statWeek').textContent = d.stats.week || 0;
            document.getElementById('statMonth').textContent = d.stats.month || 0;
        }
    });
    
    fetch('/api/commune/attendance.php?action=stats&user_id=' + currentUser.id)
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.code === 1) {
            document.getElementById('logStatCount').textContent = d.data.today_logs || 0;
        }
    });
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
if (typeof window !== 'undefined') {
    window.addEventListener('load', initAttendance);
}
</script>

</div>
            <!-- ç­¾åˆ°é¢æ¿ -->
            <div id="checkInPanel" style="display:none;background:white;border-radius:10px;padding:12px;margin-bottom:10px">
                <div style="text-align:center;padding:10px">
                    <div id="checkStatusIcon" style="font-size:28px">ğŸ“Œ</div>
                    <div id="checkStatusText" style="font-weight:600;font-size:14px;margin:5px 0">ç‚¹å‡»ç­¾åˆ°</div>
                    <div id="checkTimeText" style="font-size:11px;color:#999"></div>
                </div>
                <button id="mainCheckInBtn" class="btn btn-primary w-100" style="border-radius:6px" onclick="doCheckIn()">âœ… ç­¾åˆ°</button>
                <div style="margin-top:10px;font-size:12px;font-weight:600">ğŸ“… æœ€è¿‘</div>
                <div id="checkInList" style="font-size:11px;color:#666;margin-top:5px"></div>
            </div>
            <!-- æ—¥å¿—é¢æ¿ -->
            <div id="workLogPanel" style="display:none;background:white;border-radius:10px;padding:12px;margin-bottom:10px">
                <button class="btn btn-success w-100" style="border-radius:6px;margin-bottom:8px;font-size:13px" onclick="showAddLog()">â• å†™æ—¥å¿—</button>
                <div id="workLogList" style="max-height:150px;overflow-y:auto;font-size:12px"></div>
            </div>
        </div>
    </div>
    
    <!-- èµ„æ–™å¼¹çª— -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <h5>ğŸ‘¤ ä¸ªäººèµ„æ–™</h5>
            <input type="text" id="editNickname" placeholder="æ˜µç§°">
            <input type="tel" id="editPhone" placeholder="ç”µè¯">
            <input type="text" id="editCompany" placeholder="å…¬å¸">
            <input type="text" id="editDept" placeholder="éƒ¨é—¨">
            <input type="text" id="editPosition" placeholder="èŒä½">
            <input type="text" id="editAvatar" placeholder="å¤´åƒURL">
            
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #eee">
                <p style="font-size:12px;color:#666;margin-bottom:10px">ä¿®æ”¹å¯†ç (å¯é€‰)</p>
                <input type="password" id="oldPassword" placeholder="åŸå¯†ç ">
                <input type="password" id="newPassword" placeholder="æ–°å¯†ç ">
            </div>
            
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="saveProfile()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- é’‰é’‰æ‰«ç å¼¹çª— -->
    <div id="dingtalkModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <h5>ğŸ“± é’‰é’‰æ‰«ç ç™»å½•</h5>
            <img id="dingtalkQr" style="width:200px;height:200px;border-radius:10px;margin:15px 0">
            <p style="font-size:13px;color:#666">è¯·ä½¿ç”¨é’‰é’‰æ‰«ç </p>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeDingtalk()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="mockDingtalk()">æ¨¡æ‹Ÿæ‰«ç </button>
            </div>
        </div>
    </div>

    <script>
        let myUsername = '';
        let myNickname = '';
        
        const i18n = {
            zh: { title: 'æµ·é²œç¤¾', subtitle: 'ä¼ä¸šå·¥ä½œå°', username: 'ç”¨æˆ·å', password: 'å¯†ç ', login: 'ç™»å½•', dingtalk: 'ğŸ“± é’‰é’‰æ‰«ç ç™»å½•', contact: 'å¦‚éœ€å¼€é€šè´¦å·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', chat: 'èŠå¤©å®¤', qrcode: 'ä¸€ç‰©ä¸€ç ', inventory: 'è¿›é”€å­˜', admin: 'ç®¡ç†åå°', profile: 'ä¸ªäººèµ„æ–™', logout: 'é€€å‡ºç™»å½•', dept: 'éƒ¨é—¨', company: 'æµ·é²œç¤¾' },
            en: { title: 'Haixianshe', subtitle: 'Enterprise', username: 'Username', password: 'Password', login: 'Login', dingtalk: 'ğŸ“± DingTalk Login', contact: 'Contact admin', chat: 'Chat', qrcode: 'QR Code', inventory: 'Inventory', admin: 'Admin', profile: 'Profile', logout: 'Logout', dept: 'Department', company: 'Haixianshe' },
            ja: { title: 'æµ·é®®ç¤¾', subtitle: 'ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹', username: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', password: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', login: 'ãƒ­ã‚°ã‚¤ãƒ³', dingtalk: 'ğŸ“± é’‰é’‰ãƒ­ã‚°ã‚¤ãƒ³', contact: 'ç®¡ç†è€…ã¸', chat: 'ãƒãƒ£ãƒƒãƒˆ', qrcode: 'QRã‚³ãƒ¼ãƒ‰', inventory: 'åœ¨åº«', admin: 'ç®¡ç†', profile: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«', logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', dept: 'éƒ¨é–€', company: 'æµ·é®®ç¤¾' },
            ko: { title: 'í•´ì‚°ì‚¬', subtitle: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤', username: 'ì‚¬ìš©ì', password: 'ë¹„ë°€ë²ˆí˜¸', login: 'ë¡œê·¸ì¸', dingtalk: 'ğŸ“± é’‰gitç™»å½•', contact: 'ê´€ë¦¬ì ì—°ë½', chat: 'ì±„íŒ…', qrcode: 'QRì½”ë“œ', inventory: 'ì¬ê³ ', admin: 'ê´€ë¦¬ì', profile: 'í”„ë¡œí•„', logout: 'ë¡œê·¸ì•„ì›ƒ', dept: 'ë¶€ì„œ', company: 'í•´ì‚°ì‚¬' },
            id: { title: 'Haixianshe', subtitle: 'Workspace', username: 'Username', password: 'Password', login: 'Masuk', dingtalk: 'ğŸ“± Login DingTalk', contact: 'Hubungi admin', chat: 'Obrolan', qrcode: 'QR Code', inventory: 'Inventaris', admin: 'Admin', profile: 'Profil', logout: 'Keluar', dept: 'Dept', company: 'Haixianshe' },
            tl: { title: 'Haixianshe', subtitle: 'Workspace', username: 'Username', password: 'Password', login: 'Login', dingtalk: 'ğŸ“± DingTalk Login', contact: 'Contact admin', chat: 'Chat', qrcode: 'QR Code', inventory: 'Inventory', admin: 'Admin', profile: 'Profile', logout: 'Logout', dept: 'Dept', company: 'Haixianshe' },
            vi: { title: 'Haixianshe', subtitle: 'Workspace', username: 'Username', password: 'Password', login: 'ÄÄƒng nháº­p', dingtalk: 'ğŸ“± ÄÄƒng nháº­p DingTalk', contact: 'LiÃªn há»‡ admin', chat: 'PhÃ²ng chat', qrcode: 'MÃ£ QR', inventory: 'Kho hÃ ng', admin: 'Quáº£n trá»‹', profile: 'Há»“ sÆ¡', logout: 'ÄÄƒng xuáº¥t', dept: 'PhÃ²ng', company: 'Haixianshe' }
        };
        
        // æ™ºèƒ½è¯­è¨€æ£€æµ‹
        function detectLanguage() {
            // 1. ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„è¯­è¨€
            var saved = localStorage.getItem('lang');
            if (saved && i18n[saved]) return saved;
            
            // 2. æ£€æµ‹æµè§ˆå™¨è¯­è¨€
            var browserLang = navigator.language || navigator.userLanguage;
            if (browserLang) {
                browserLang = browserLang.toLowerCase();
                if (browserLang.startsWith('zh')) return 'zh';
                if (browserLang.startsWith('en')) return 'en';
                if (browserLang.startsWith('ja')) return 'ja';
                if (browserLang.startsWith('ko')) return 'ko';
                if (browserLang.startsWith('id')) return 'id';
                if (browserLang.startsWith('vi')) return 'vi';
                if (browserLang.startsWith('tl')) return 'tl';
            }
            
            // 3. é»˜è®¤ä¸­æ–‡
            return 'zh';
        }
        
        let currentLang = detectLanguage();
        
        function changeLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            updateLabels();
        }
        
        function updateLabels() {
            const t = i18n[currentLang] || i18n.zh;
            document.getElementById('titleText').textContent = t.title;
            document.getElementById('subtitleText').textContent = t.subtitle;
            document.getElementById('loginUsername').placeholder = t.username;
            document.getElementById('loginPassword').placeholder = t.password;
            document.getElementById('loginBtn').textContent = t.login;
            document.getElementById('dingtalkBtn').innerHTML = t.dingtalk;
            document.getElementById('contactText').textContent = t.contact;
            document.getElementById('langSelect').value = currentLang;
            
            if (myUsername) {
                document.getElementById('menuChat1').textContent = t.chat;
                document.getElementById('menuQrcode1').textContent = t.qrcode;
                document.getElementById('menuInventory1').textContent = t.inventory;
                document.getElementById('menuAdmin1').textContent = t.admin;
                document.getElementById('userCompany').textContent = t.company;
            }
        }
        
        function checkLogin() {
            const stored = localStorage.getItem('commune_user');
            if (stored) {
                try {
                    const u = JSON.parse(stored);
                    if (u.username) {
                        myUsername = u.username;
                        myNickname = u.nickname || u.username;
                        showHome(u);
                        return;
                    }
                } catch(e) {}
            }
            showLogin();
        }
        
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('homePage').style.display = 'none';
        }
        
        function showHome(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('homePage').style.display = 'block';
            
            const t = i18n[currentLang] || i18n.zh;
            document.getElementById('userName').textContent = user.nickname || user.username;
            document.getElementById('userAvatar').textContent = (user.nickname || user.username).charAt(0);
            document.getElementById('userDept').textContent = (user.department || t.dept) + ' ' + (user.position || '');
            document.getElementById('userCompany').textContent = user.company || t.company;
            document.getElementById('langSelect').value = user.lang || currentLang;
            
            if (user.role === 'admin') {
                document.getElementById('adminLink').style.display = 'block';
            }
            
            localStorage.setItem('commune_user', JSON.stringify(user));
        }
        
        // ç™»å½•
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            fetch('/api/commune/user.php?action=login', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password)
            })
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    fetch('/api/commune/profile.php?action=profile&username=' + username)
                    .then(r => r.json())
                    .then(profile => {
                        if (profile.code === 1) showHome(profile.data);
                        else showHome(data.data);
                    });
                } else {
                    document.getElementById('loginError').textContent = data.msg || 'ç™»å½•å¤±è´¥';
                    document.getElementById('loginError').style.display = 'block';
                }
            });
        });
        
        // é’‰é’‰ç™»å½•
        function dingtalkLogin() {
            document.getElementById('dingtalkModal').classList.add('show');
            fetch('/api/commune/dingtalk.php?action=get_qr')
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    document.getElementById('dingtalkQr').src = data.data.qr_image;
                }
            });
        }
        
        function mockDingtalk() {
            const username = prompt('è¾“å…¥æ¨¡æ‹Ÿç”¨æˆ·å:', 'user' + Math.floor(Math.random()*1000));
            if (!username) return;
            
            fetch('/api/commune/dingtalk.php?action=create_demo_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'username=' + username + '&nickname=' + username + '&company=æµ‹è¯•å…¬å¸&department=æµ‹è¯•éƒ¨é—¨'
            })
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    closeDingtalk();
                    showHome({ username: username, nickname: username, role: 'user', company: 'æµ‹è¯•å…¬å¸', department: 'æµ‹è¯•éƒ¨é—¨', lang: currentLang });
                } else {
                    alert(data.msg);
                }
            });
        }
        
        function closeDingtalk() {
            document.getElementById('dingtalkModal').classList.remove('show');
        }
        
        function logout() {
            localStorage.removeItem('commune_user');
            location.reload();
        }
        
        function showProfile() {
            fetch('/api/commune/profile.php?action=profile&username=' + myUsername)
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    const u = data.data;
                    document.getElementById('editNickname').value = u.nickname || '';
                    document.getElementById('editPhone').value = u.phone || '';
                    document.getElementById('editCompany').value = u.company || '';
                    document.getElementById('editDept').value = u.department || '';
                    document.getElementById('editPosition').value = u.position || '';
                    document.getElementById('editAvatar').value = u.avatar_url || '';
                }
            });
            document.getElementById('profileModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('profileModal').classList.remove('show');
        }
        
        function saveProfile() {
            const nickname = document.getElementById('editNickname').value;
            const phone = document.getElementById('editPhone').value;
            const company = document.getElementById('editCompany').value;
            const dept = document.getElementById('editDept').value;
            const position = document.getElementById('editPosition').value;
            const avatar_url = document.getElementById('editAvatar').value;
            const old_password = document.getElementById('oldPassword').value;
            const new_password = document.getElementById('newPassword').value;
            
            fetch('/api/commune/profile.php?action=update_my_profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'username=' + myUsername + 
                    '&nickname=' + encodeURIComponent(nickname) + 
                    '&phone=' + encodeURIComponent(phone) +
                    '&company=' + encodeURIComponent(company) +
                    '&department=' + encodeURIComponent(dept) +
                    '&position=' + encodeURIComponent(position) +
                    '&avatar_url=' + encodeURIComponent(avatar_url) +
                    (old_password ? '&old_password=' + old_password : '') +
                    (new_password ? '&new_password=' + new_password : '')
            })
            .then(r => r.json())
            .then(data => {
                alert(data.msg);
                if (data.code === 1) {
                    closeModal();
                    myNickname = nickname;
                    document.getElementById('userName').textContent = nickname;
                    document.getElementById('userAvatar').textContent = nickname.charAt(0);
                }
            });
        }
        
        // åˆå§‹åŒ–
        currentLang = localStorage.getItem('lang') || 'zh';
        checkLogin();
        updateLabels();
        
        // æ£€æŸ¥ç­¾åˆ°çŠ¶æ€
        checkTodayStatus();
    </script>
    
    <script>
        // ========== ç­¾åˆ°å’Œæ—¥å¿— ==========
        function getUserInfo() {
            try {
                const stored = localStorage.getItem('commune_user');
                if (stored) return JSON.parse(stored);
            } catch(e) {}
            return { id: 1, username: 'ç”¨æˆ·', nickname: 'ç”¨æˆ·' };
        }
        
        function toggleQuickAction(type) {
            if (type === 'checkin') {
                const p = document.getElementById('checkInPanel');
                p.style.display = p.style.display === 'none' ? 'block' : 'none';
                document.getElementById('workLogPanel').style.display = 'none';
                document.getElementById('statsPanel').style.display = 'none';
                if (p.style.display === 'block') loadCheckIn();
            } else if (type === 'worklog') {
                const p = document.getElementById('workLogPanel');
                p.style.display = p.style.display === 'none' ? 'block' : 'none';
                document.getElementById('checkInPanel').style.display = 'none';
                document.getElementById('statsPanel').style.display = 'none';
                if (p.style.display === 'block') loadWorkLog();
            } else if (type === 'stats') {
                const p = document.getElementById('statsPanel');
                p.style.display = p.style.display === 'none' ? 'block' : 'none';
                document.getElementById('checkInPanel').style.display = 'none';
                document.getElementById('workLogPanel').style.display = 'none';
                if (p.style.display === 'block') loadStats();
            }
        }
        
        function checkTodayStatus() {
            const user = getUserInfo();
            fetch('/api/commune/attendance.php?action=today_status&user_id=' + (user.id || 1) + '&user_name=' + encodeURIComponent(user.nickname || user.username))
            .then(r => r.json())
            .then(d => {
                if (d.code === 1 && d.data.checked) {
                    document.getElementById('checkInIcon').textContent = 'âœ…';
                    document.getElementById('checkInText').textContent = 'å·²ç­¾åˆ°';
                }
            });
        }
        
        function loadCheckIn() {
            const user = getUserInfo();
            fetch('/api/commune/attendance.php?action=today_status&user_id=' + (user.id || 1) + '&user_name=' + encodeURIComponent(user.nickname || user.username))
            .then(r => r.json())
            .then(d => {
                if (d.code === 1) {
                    if (d.data.checked) {
                        document.getElementById('checkStatusIcon').textContent = 'âœ…';
                        document.getElementById('checkStatusText').textContent = 'å·²ç­¾åˆ°';
                        document.getElementById('checkTimeText').textContent = 'ç­¾åˆ°æ—¶é—´: ' + d.data.time;
                        if (d.data.location) {
                            document.getElementById('checkLocationText').textContent = 'ğŸ“ ' + d.data.location;
                        }
                        document.getElementById('checkInForm').style.display = 'none';
                    } else {
                        document.getElementById('checkStatusIcon').textContent = 'ğŸ“Œ';
                        document.getElementById('checkStatusText').textContent = 'ç‚¹å‡»ç­¾åˆ°';
                        document.getElementById('checkTimeText').textContent = '';
                        document.getElementById('checkLocationText').textContent = '';
                        document.getElementById('checkInForm').style.display = 'block';
                        // è‡ªåŠ¨è·å–ä½ç½®
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(pos) {
                                document.getElementById('checkLocation').placeholder = 'ğŸ“ ä½ç½®: ' + pos.coords.latitude.toFixed(4) + ', ' + pos.coords.longitude.toFixed(4);
                            }, function() {
                                document.getElementById('checkLocation').placeholder = 'ğŸ“ ç‚¹å‡»è·å–ä½ç½®';
                            });
                        }
                    }
                }
            });
            loadCheckInList();
        }
        
        function loadCheckInList() {
            fetch('/api/commune/attendance.php?action=attendance_list&user_id=1&limit=10')
            .then(r => r.json())
            .then(d => {
                if (d.code === 1) {
                    let html = '';
                    d.data.forEach(item => {
                        let loc = item.location ? ' ğŸ“' + item.location : '';
                        let remark = item.remark ? ' - ' + item.remark : '';
                        html += '<div style="padding:6px 8px;background:#f8f9fa;border-radius:4px;margin-bottom:6px"><div style="font-weight:500">' + item.user_name + '</div><div style="font-size:11px;color:#666">' + item.check_date + ' ' + item.check_time + loc + remark + '</div></div>';
                    });
                    document.getElementById('checkInList').innerHTML = html || '<div style="color:#999">æš‚æ— è®°å½•</div>';
                }
            });
        }
        
        function doCheckIn() {
            const user = getUserInfo();
            const location = document.getElementById('checkLocation').value;
            const remark = document.getElementById('checkRemark').value;
            
            fetch('/api/commune/attendance.php?action=check_in', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'user_id=' + (user.id || 1) + '&user_name=' + encodeURIComponent(user.nickname || user.username) + '&location=' + encodeURIComponent(location) + '&remark=' + encodeURIComponent(remark)
            })
            .then(r => r.json())
            .then(d => {
                alert(d.msg);
                if (d.code === 1) {
                    loadCheckIn();
                    checkTodayStatus();
                }
            });
        }
        
        function loadWorkLog() {
            fetch('/api/commune/attendance.php?action=log_list&user_id=1')
            .then(r => r.json())
            .then(d => {
                if (d.code === 1) {
                    let html = '';
                    d.data.slice(0, 10).forEach(item => {
                        html += '<div style="padding:8px;background:#f8f9fa;border-radius:6px;margin-bottom:6px"><div style="font-weight:500;font-size:11px;color:#666">' + item.user_name + ' - ' + item.log_date + '</div><div style="font-size:12px">' + item.content + '</div></div>';
                    });
                    document.getElementById('workLogList').innerHTML = html || '<div style="color:#999;text-align:center;padding:15px">æš‚æ— æ—¥å¿—</div>';
                }
            });
        }
        
        function showAddLog() {
            const user = getUserInfo();
            const content = prompt('è¯·è¾“å…¥å·¥ä½œæ—¥å¿—å†…å®¹:');
            if (!content) return;
            const logType = selectedLogType || 'daily';
            fetch('/api/commune/attendance.php?action=add_log', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'user_id=' + (user.id || 1) + '&user_name=' + encodeURIComponent(user.nickname || user.username) + '&content=' + encodeURIComponent(content) + '&log_type=' + logType
            })
            .then(r => r.json())
            .then(d => {
                alert(d.msg);
                if (d.code === 1) loadWorkLog();
            });
        }
        
        var selectedLogType = 'daily';
        
        function selectLogType(type) {
            selectedLogType = type;
            document.querySelectorAll('.log-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                }
            });
            loadWorkLog();
        }
        
        function loadWorkLog() {
            fetch('/api/commune/attendance.php?action=log_list&user_id=1&log_type=' + (selectedLogType || ''))
            .then(r => r.json())
            .then(d => {
                if (d.code === 1) {
                    let html = '';
                    const typeIcons = {'daily':'ğŸ“‹','weekly':'ğŸ“…','project':'ğŸ“','meeting':'ğŸ‘¥','other':'ğŸ“'};
                    d.data.forEach(item => {
                        let icon = typeIcons[item.log_type] || 'ğŸ“';
                        html += '<div style="padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:11px;color:#666"><span>' + icon + ' ' + item.user_name + '</span><span>' + item.log_date + '</span></div><div style="font-size:13px">' + item.content + '</div></div>';
                    });
                    document.getElementById('workLogList').innerHTML = html || '<div style="color:#999;text-align:center;padding:20px">æš‚æ— æ—¥å¿—</div>';
                }
            });
        }
        
        function loadStats() {
            fetch('/api/commune/attendance.php?action=attendance_list&user_id=1&limit=100')
            .then(r => r.json())
            .then(d => {
                if (d.code === 1 && d.stats) {
                    document.getElementById('statToday').textContent = d.stats.today || 0;
                    document.getElementById('statWeek').textContent = d.stats.week || 0;
                    document.getElementById('statMonth').textContent = d.stats.month || 0;
                }
            });
            fetch('/api/commune/attendance.php?action=stats')
            .then(r => r.json())
            .then(d => {
                if (d.code === 1) {
                    document.getElementById('logStatCount').textContent = d.data.today_logs || 0;
                }
            });
        }
    </script>
<!-- é’‰é’‰é£æ ¼æ—¥å¿—ç»„ä»¶ -->
<div id="workLogModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
    <div style="background:white;border-radius:16px;width:90%;max-width:400px;max-height:85vh;overflow-y:auto">
        <div style="padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600;font-size:16px">ğŸ“ å†™æ—¥å¿—</span>
            <span onclick="closeLogModal()" style="font-size:24px;cursor:pointer">&times;</span>
        </div>
        
        <!-- æ—¥å¿—ç±»å‹é€‰æ‹© -->
        <div style="padding:12px;border-bottom:1px solid #eee">
            <div style="font-size:12px;color:#666;margin-bottom:8px">æ—¥å¿—ç±»å‹</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button onclick="selectLogType('daily')" class="log-type-btn active" data-type="daily" style="padding:8px 12px;border:1px solid #4caf50;background:#4caf50;color:white;border-radius:20px;font-size:12px">ğŸ“‹ æ—¥æŠ¥</button>
                <button onclick="selectLogType('weekly')" class="log-type-btn" data-type="weekly" style="padding:8px 12px;border:1px solid #2196f3;background:white;color:#2196f3;border-radius:20px;font-size:12px">ğŸ“… å‘¨æŠ¥</button>
                <button onclick="selectLogType('project')" class="log-type-btn" data-type="project" style="padding:8px 12px;border:1px solid #ff9800;background:white;color:#ff9800;border-radius:20px;font-size:12px">ğŸ“ é¡¹ç›®</button>
                <button onclick="selectLogType('meeting')" class="log-type-btn" data-type="meeting" style="padding:8px 12px;border:1px solid #9c27b0;background:white;color:#9c27b0;border-radius:20px;font-size:12px">ğŸ‘¥ ä¼šè®®</button>
            </div>
        </div>
        
        <!-- æ—¥æŠ¥æ¨¡æ¿ -->
        <div id="dailyTemplate" style="padding:15px">
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“‹ ä»Šæ—¥å·¥ä½œ *</div>
                <textarea id="logContent1" placeholder="1. å®Œæˆäº†...&#10;2. å‚ä¸äº†...&#10;3. å¤„ç†äº†..." style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ¯ æ˜æ—¥è®¡åˆ’</div>
                <textarea id="logContent2" placeholder="1. è®¡åˆ’...&#10;2. å‡†å¤‡..." style="width:100%;height:60px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">âš ï¸ é—®é¢˜/å»ºè®®</div>
                <textarea id="logContent3" placeholder="é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®..." style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
        </div>
        
        <!-- å‘¨æŠ¥æ¨¡æ¿ -->
        <div id="weeklyTemplate" style="padding:15px;display:none">
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“… æœ¬å‘¨å·¥ä½œæ€»ç»“ *</div>
                <textarea id="logWeekly1" placeholder="æœ¬å‘¨å®Œæˆçš„ä¸»è¦å·¥ä½œ..." style="width:100%;height:100px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ¯ ä¸‹å‘¨è®¡åˆ’</div>
                <textarea id="logWeekly2" placeholder="ä¸‹å‘¨è®¡åˆ’..." style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
        </div>
        
        <!-- é¡¹ç›®æ¨¡æ¿ -->
        <div id="projectTemplate" style="padding:15px;display:none">
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“ é¡¹ç›®åç§°</div>
                <input id="logProjectName" placeholder="é¡¹ç›®åç§°" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px">
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“ è¿›å±• *</div>
                <textarea id="logProject1" placeholder="é¡¹ç›®è¿›å±•è¯´æ˜..." style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">âš ï¸ é—®é¢˜å’Œé£é™©</div>
                <textarea id="logProject2" placeholder="é‡åˆ°çš„é—®é¢˜..." style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
        </div>
        
        <!-- ä¼šè®®æ¨¡æ¿ -->
        <div id="meetingTemplate" style="padding:15px;display:none">
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ‘¥ ä¼šè®®ä¸»é¢˜ *</div>
                <input id="logMeetingTopic" placeholder="ä¼šè®®ä¸»é¢˜" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px">
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“‹ ä¼šè®®ç»“è®º *</div>
                <textarea id="logMeeting1" placeholder="ä¼šè®®ç»“è®º..." style="width:100%;height:80px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
            <div style="margin-bottom:15px">
                <div style="font-size:13px;color:#666;margin-bottom:5px">ğŸ“ å¾…åŠäº‹é¡¹</div>
                <textarea id="logMeeting2" placeholder="1. ...&#10;2. ..." style="width:100%;height:50px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;resize:none"></textarea>
            </div>
        </div>
        
        <!-- æäº¤æŒ‰é’® -->
        <div style="padding:15px;border-top:1px solid #eee;display:flex;gap:10px">
            <button onclick="closeLogModal()" style="flex:1;padding:12px;background:#f5f5f5;color:#666;border:none;border-radius:8px;font-size:14px">å–æ¶ˆ</button>
            <button onclick="submitLog()" style="flex:1;padding:12px;background:#4caf50;color:white;border:none;border-radius:8px;font-size:14px">æäº¤</button>
        </div>
    </div>
</div>

<script>
// æ—¥å¿—ç±»å‹é€‰æ‹©
function selectLogType(type) {
    currentLogType = type;
    // æ›´æ–°æŒ‰é’®æ ·å¼
    document.querySelectorAll('.log-type-btn').forEach(function(btn) {
        var colors = {'daily':'#4caf50','weekly':'#2196f3','project':'#ff9800','meeting':'#9c27b0'};
        if (btn.dataset.type === type) {
            btn.style.background = colors[type];
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.color = colors[btn.dataset.type];
        }
    });
    // æ˜¾ç¤ºå¯¹åº”æ¨¡æ¿
    document.getElementById('dailyTemplate').style.display = type === 'daily' ? 'block' : 'none';
    document.getElementById('weeklyTemplate').style.display = type === 'weekly' ? 'block' : 'none';
    document.getElementById('projectTemplate').style.display = type === 'project' ? 'block' : 'none';
    document.getElementById('meetingTemplate').style.display = type === 'meeting' ? 'block' : 'none';
}

// æ‰“å¼€æ—¥å¿—å¼¹çª—
function showAddLog() {
    document.getElementById('workLogModal').style.display = 'flex';
    // æ¸…ç©ºè¡¨å•
    var inputs = document.querySelectorAll('#workLogModal input, #workLogModal textarea');
    inputs.forEach(function(input) { input.value = ''; });
}

// å…³é—­æ—¥å¿—å¼¹çª—
function closeLogModal() {
    document.getElementById('workLogModal').style.display = 'none';
}

// æäº¤æ—¥å¿—
function submitLog() {
    var content = '';
    var type = currentLogType || 'daily';
    
    if (type === 'daily') {
        var c1 = document.getElementById('logContent1').value.trim();
        var c2 = document.getElementById('logContent2').value.trim();
        var c3 = document.getElementById('logContent3').value.trim();
        if (!c1) { alert('è¯·å¡«å†™ä»Šæ—¥å·¥ä½œ'); return; }
        content = 'ã€ä»Šæ—¥å·¥ä½œã€‘\n' + c1;
        if (c2) content += '\n\nã€æ˜æ—¥è®¡åˆ’ã€‘\n' + c2;
        if (c3) content += '\n\nã€é—®é¢˜/å»ºè®®ã€‘\n' + c3;
    } else if (type === 'weekly') {
        var w1 = document.getElementById('logWeekly1').value.trim();
        var w2 = document.getElementById('logWeekly2').value.trim();
        if (!w1) { alert('è¯·å¡«å†™æœ¬å‘¨å·¥ä½œæ€»ç»“'); return; }
        content = 'ã€æœ¬å‘¨å·¥ä½œæ€»ç»“ã€‘\n' + w1;
        if (w2) content += '\n\nã€ä¸‹å‘¨è®¡åˆ’ã€‘\n' + w2;
    } else if (type === 'project') {
        var p1 = document.getElementById('logProjectName').value.trim();
        var p2 = document.getElementById('logProject1').value.trim();
        var p3 = document.getElementById('logProject2').value.trim();
        if (!p1 || !p2) { alert('è¯·å¡«å†™é¡¹ç›®åç§°å’Œè¿›å±•'); return; }
        content = 'ã€é¡¹ç›®ã€‘' + p1 + '\n\nã€è¿›å±•ã€‘\n' + p2;
        if (p3) content += '\n\nã€é—®é¢˜ã€‘\n' + p3;
    } else if (type === 'meeting') {
        var m1 = document.getElementById('logMeetingTopic').value.trim();
        var m2 = document.getElementById('logMeeting1').value.trim();
        var m3 = document.getElementById('logMeeting2').value.trim();
        if (!m1 || !m2) { alert('è¯·å¡«å†™ä¼šè®®ä¸»é¢˜å’Œç»“è®º'); return; }
        content = 'ã€ä¸»é¢˜ã€‘' + m1 + '\n\nã€ç»“è®ºã€‘\n' + m2;
        if (m3) content += '\n\nã€å¾…åŠã€‘\n' + m3;
    }
    
    fetch('/api/commune/attendance.php?action=add_log', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'user_id=' + currentUser.id + '&user_name=' + encodeURIComponent(currentUser.name) + '&content=' + encodeURIComponent(content) + '&log_type=' + type
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        alert(d.msg);
        if (d.code === 1) {
            closeLogModal();
            loadWorkLog();
        }
    });
}
</script>

</body>
</html>
