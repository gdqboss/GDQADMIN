<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ä¸€ç‰©ä¸€ç  - æµ·é²œç¤¾</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; min-height: 100vh; background: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .top-nav {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .top-nav a { color: white; text-decoration: none; font-size: 18px; }
        .top-nav .title { font-size: 18px; font-weight: 600; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            color: white;
        }
        
        .stat-card.warning { background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); }
        .stat-card.green { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); }
        
        .stat-num { font-size: 22px; font-weight: bold; }
        .stat-label { font-size: 11px; opacity: 0.9; margin-top: 4px; }
        
        /* æ“ä½œæ  */
        .action-bar {
            padding: 12px 15px;
            background: white;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-bar .btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(135deg, #4caf50, #2e7d32); }
        .btn-danger { background: linear-gradient(135deg, #f44336, #c62828); }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #ff5722); color: white; }
        
        /* æœç´¢æ  */
        .search-bar {
            padding: 12px 15px;
            background: white;
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .search-bar input, .search-bar select {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            background: #f8f9fa;
        }
        
        .search-bar input { flex: 1; }
        .search-bar select { min-width: 100px; }
        
        /* åˆ—è¡¨ */
        .qr-list { padding: 0 15px; }
        
        .qr-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .qr-header {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .qr-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }
        
        .qr-code {
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .qr-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: auto;
        }
        
        .qr-status.active { background: #e8f5e9; color: #2e7d32; }
        .qr-status.used { background: #e3f2fd; color: #1565c0; }
        .qr-status.scrap { background: #ffebee; color: #c62828; }
        
        .qr-body {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qr-product {
            flex: 1;
        }
        
        .qr-product-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .qr-product-sku {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        
        .qr-actions {
            display: flex;
            gap: 8px;
        }
        
        .qr-actions .btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            border: none;
        }
        
        /* å…¨é€‰æ  */
        .select-bar {
            padding: 10px 15px;
            background: #e8f4ff;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .select-bar.show { display: flex; }
        
        .select-bar .count { font-size: 13px; color: #333; }
        
        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h5 { margin: 0; font-size: 16px; }
        .modal-header .close { font-size: 24px; cursor: pointer; }
        
        .modal-body { padding: 20px; }
        
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { font-size: 13px; color: #666; margin-bottom: 6px; display: block; }
        .modal-body input, .modal-body select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
        }
        
        .modal-footer .btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
        }
        
        /* äºŒç»´ç æ˜¾ç¤º */
        .qr-display {
            text-align: center;
            padding: 20px;
        }
        
        .qr-display img {
            width: 200px;
            height: 200px;
            border-radius: 10px;
        }
        
        .qr-display .code {
            font-family: monospace;
            font-size: 16px;
            margin-top: 15px;
            padding: 10px 20px;
            background: #f5f5f5;
            border-radius: 8px;
            display: inline-block;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i { font-size: 48px; margin-bottom: 15px; }
        
        /* åŠ è½½ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        /* é¡µè„š */
        .page-footer {
            padding: 15px;
            text-align: center;
        }
        
        .page-footer .btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <a href="/"><i class="bi bi-house"></i></a>
        <span class="title">ğŸ·ï¸ ä¸€ç‰©ä¸€ç </span>
        <a href="#" onclick="showGenerateModal()"><i class="bi bi-plus-lg"></i></a>
    </div>
    
    <!-- ç»Ÿè®¡ -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-num" id="statTotal">0</div>
            <div class="stat-label">æ€»äºŒç»´ç </div>
        </div>
        <div class="stat-card green">
            <div class="stat-num" id="statToday">0</div>
            <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
        </div>
        <div class="stat-card blue">
            <div class="stat-num" id="statLinked">0</div>
            <div class="stat-label">å·²å…³è”å•†å“</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-num" id="statScanned">0</div>
            <div class="stat-label">æ‰«ç æ¬¡æ•°</div>
        </div>
    </div>
    
    <!-- æ“ä½œæ  -->
    <div class="action-bar">
        <button class="btn btn-primary" onclick="showGenerateModal()">
            <i class="bi bi-qr-code"></i> ç”ŸæˆäºŒç»´ç 
        </button>
        <button class="btn btn-success" onclick="showBatchLinkModal()">
            <i class="bi bi-link-45deg"></i> æ‰¹é‡å…³è”
        </button>
        <button class="btn btn-warning" onclick="showBatchModal()">
            <i class="bi bi-pencil"></i> æ‰¹é‡æ“ä½œ
        </button>
    </div>
    
    <!-- æœç´¢ -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢äºŒç»´ç ç¼–ç ã€å•†å“åç§°..." oninput="searchQR()">
        <select id="statusFilter" onchange="searchQR()">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="active">å¯ç”¨</option>
            <option value="used">å·²ç”¨</option>
            <option value="scrap">å·²æŠ¥åºŸ</option>
        </select>
    </div>
    
    <!-- å…¨é€‰æ  -->
    <div class="select-bar" id="selectBar">
        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
        <label for="selectAll">å…¨é€‰</label>
        <span class="count">å·²é€‰ <span id="selectedCount">0</span> ä¸ª</span>
        <button class="btn btn-danger btn-sm" onclick="batchDelete()" style="margin-left:auto">åˆ é™¤</button>
    </div>
    
    <!-- åˆ—è¡¨ -->
    <div class="qr-list" id="qrList">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
    
    <!-- é¡µè„š -->
    <div class="page-footer">
        <button class="btn" onclick="loadMore()">åŠ è½½æ›´å¤š</button>
    </div>

    <!-- ç”ŸæˆäºŒç»´ç å¼¹çª— -->
    <div class="modal" id="generateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>ğŸ“± ç”ŸæˆäºŒç»´ç </h5>
                <span class="close" onclick="closeModal('generateModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç”Ÿæˆæ–¹å¼</label>
                    <select id="generateType" onchange="toggleGenerateType()">
                        <option value="single">å•ä¸ªäºŒç»´ç </option>
                        <option value="batch">æ‰¹é‡ç”Ÿæˆ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å‰ç¼€ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="prefix" placeholder="é»˜è®¤: QR" value="QR">
                </div>
                
                <div class="form-group">
                    <label>å…³è”å•†å“ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="productSelect" onchange="loadSKUs()">
                        <option value="">ä¸å…³è”å•†å“</option>
                    </select>
                </div>
                
                <div class="form-group" id="skuGroup" style="display:none">
                    <label>SKUï¼ˆå¯é€‰ï¼‰</label>
                    <select id="skuSelect">
                        <option value="">ä¸å…³è”SKU</option>
                    </select>
                </div>
                
                <div class="form-group" id="quantityGroup" style="display:none">
                    <label>ç”Ÿæˆæ•°é‡ï¼ˆ1-1000ï¼‰</label>
                    <input type="number" id="quantity" value="10" min="1" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#f5f5f5" onclick="closeModal('generateModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="generateQR()">ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹é‡å…³è”å¼¹çª— -->
    <div class="modal" id="batchLinkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>ğŸ”— æ‰¹é‡å…³è”å•†å“</h5>
                <span class="close" onclick="closeModal('batchLinkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="font-size:13px;color:#666;margin-bottom:15px">å°†é€‰ä¸­çš„äºŒç»´ç å…³è”åˆ°æŒ‡å®šå•†å“</p>
                
                <div class="form-group">
                    <label>é€‰æ‹©å•†å“</label>
                    <select id="linkProductSelect" onchange="loadLinkSKUs()">
                        <option value="">ä¸å…³è”å•†å“</option>
                    </select>
                </div>
                
                <div class="form-group" id="linkSkuGroup" style="display:none">
                    <label>é€‰æ‹©SKUï¼ˆå¯é€‰ï¼‰</label>
                    <select id="linkSkuSelect">
                        <option value="">ä¸å…³è”SKU</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#f5f5f5" onclick="closeModal('batchLinkModal')">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="batchLink()">ç¡®è®¤å…³è”</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œå¼¹çª— -->
    <div class="modal" id="batchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>âš™ï¸ æ‰¹é‡æ“ä½œ</h5>
                <span class="close" onclick="closeModal('batchModal')">&times;</span>
            </div>
            <div class="modal-body" style="text-align:center">
                <p>å·²é€‰æ‹© <span id="batchCount">0</span> ä¸ªäºŒç»´ç </p>
                <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
                    <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å•ä¸ªäºŒç»´ç è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="qrDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>ğŸ·ï¸ äºŒç»´ç è¯¦æƒ…</h5>
                <span class="close" onclick="closeModal('qrDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="qr-display" id="qrDisplay"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('qrDetailModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let selectedIds = [];
        let allData = [];
        let hasMore = true;
        
        // åŠ è½½ç»Ÿè®¡
        function loadStats() {
            fetch('/api/commune/qrcode.php?action=stats')
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    document.getElementById('statTotal').textContent = data.data.total;
                    document.getElementById('statToday').textContent = data.data.today;
                    document.getElementById('statLinked').textContent = data.data.linked;
                    document.getElementById('statScanned').textContent = data.data.scanned;
                }
            });
        }
        
        // åŠ è½½å•†å“åˆ—è¡¨
        function loadProducts(selectId) {
            fetch('/api/commune/qrcode.php?action=get_products')
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">ä¸å…³è”å•†å“</option>';
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            });
        }
        
        // åŠ è½½SKU
        function loadSKUs() {
            const productId = document.getElementById('productSelect').value;
            const skuGroup = document.getElementById('skuGroup');
            
            if (!productId) {
                skuGroup.style.display = 'none';
                return;
            }
            
            fetch('/api/commune/qrcode.php?action=get_skus&product_id=' + productId)
            .then(r => r.json())
            .then(data => {
                if (data.code === 1 && data.data.length > 0) {
                    skuGroup.style.display = 'block';
                    const select = document.getElementById('skuSelect');
                    select.innerHTML = '<option value="">ä¸å…³è”SKU</option>';
                    data.data.forEach(s => {
                        const spec = [s.spec1, s.spec2].filter(x => x).join(' / ');
                        select.innerHTML += `<option value="${s.id}">${s.sku_name} ${spec}</option>`;
                    });
                } else {
                    skuGroup.style.display = 'none';
                }
            });
        }
        
        function loadLinkSKUs() {
            const productId = document.getElementById('linkProductSelect').value;
            const skuGroup = document.getElementById('linkSkuGroup');
            
            if (!productId) {
                skuGroup.style.display = 'none';
                return;
            }
            
            fetch('/api/commune/qrcode.php?action=get_skus&product_id=' + productId)
            .then(r => r.json())
            .then(data => {
                if (data.code === 1 && data.data.length > 0) {
                    skuGroup.style.display = 'block';
                    const select = document.getElementById('linkSkuSelect');
                    select.innerHTML = '<option value="">ä¸å…³è”SKU</option>';
                    data.data.forEach(s => {
                        const spec = [s.spec1, s.spec2].filter(x => x).join(' / ');
                        select.innerHTML += `<option value="${s.id}">${s.sku_name} ${spec}</option>`;
                    });
                } else {
                    skuGroup.style.display = 'none';
                }
            });
        }
        
        // åˆ‡æ¢ç”Ÿæˆç±»å‹
        function toggleGenerateType() {
            const type = document.getElementById('generateType').value;
            document.getElementById('quantityGroup').style.display = type === 'batch' ? 'block' : 'none';
        }
        
        // æœç´¢
        function searchQR() {
            currentPage = 1;
            allData = [];
            selectedIds = [];
            updateSelectBar();
            loadQR();
        }
        
        // åŠ è½½äºŒç»´ç åˆ—è¡¨
        function loadQR(append = false) {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            
            fetch('/api/commune/qrcode.php?action=list&search=' + encodeURIComponent(search) + '&status=' + status + '&page=' + currentPage + '&limit=20')
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    if (append) {
                        allData = allData.concat(data.data.list);
                    } else {
                        allData = data.data.list;
                    }
                    hasMore = data.data.list.length >= 20;
                    renderQR();
                }
            });
        }
        
        function loadMore() {
            currentPage++;
            loadQR(true);
        }
        
        // æ¸²æŸ“åˆ—è¡¨
        function renderQR() {
            const container = document.getElementById('qrList');
            
            if (allData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-qr-code"></i>
                        <p>æš‚æ— äºŒç»´ç <br>ç‚¹å‡»å³ä¸Šè§’ + ç”Ÿæˆ</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            allData.forEach((q, index) => {
                const isSelected = selectedIds.includes(q.id);
                const statusText = q.status === 'active' ? 'å¯ç”¨' : (q.status === 'used' ? 'å·²ç”¨' : 'å·²æŠ¥åºŸ');
                const productHtml = q.product_id > 0 
                    ? `<div class="qr-product-name">${q.product_name}</div>
                       <div class="qr-product-sku">${q.sku_name || 'æ— SKU'} ${q.sku_spec || ''}</div>`
                    : `<div class="qr-product-name" style="color:#999">æœªå…³è”å•†å“</div>`;
                
                html += `
                    <div class="qr-card">
                        <div class="qr-header">
                            <input type="checkbox" class="qr-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect(${q.id})">
                            <span class="qr-code">${q.code}</span>
                            <span class="qr-status ${q.status}">${statusText}</span>
                        </div>
                        <div class="qr-body">
                            <div class="qr-product">${productHtml}</div>
                            <div class="qr-actions">
                                <button class="btn" style="background:#e3f2fd;color:#1976d2" onclick="showQRDetail(${q.id}, '${q.code}')">æŸ¥çœ‹</button>
                                <button class="btn" style="background:#fff3e0;color:#e65100" onclick="linkProduct(${q.id})">å…³è”</button>
                                <button class="btn" style="background:#ffebee;color:#c62828" onclick="deleteQR(${q.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // é€‰æ‹©/å–æ¶ˆé€‰æ‹©
        function toggleSelect(id) {
            const idx = selectedIds.indexOf(id);
            if (idx > -1) {
                selectedIds.splice(idx, 1);
            } else {
                selectedIds.push(id);
            }
            updateSelectBar();
        }
        
        // å…¨é€‰
        function toggleSelectAll() {
            const checkAll = document.getElementById('selectAll').checked;
            if (checkAll) {
                selectedIds = allData.map(q => q.id);
            } else {
                selectedIds = [];
            }
            renderQR();
            updateSelectBar();
        }
        
        // æ›´æ–°é€‰æ‹©æ 
        function updateSelectBar() {
            const bar = document.getElementById('selectBar');
            const count = document.getElementById('selectedCount');
            const checkAll = document.getElementById('selectAll');
            
            if (selectedIds.length > 0) {
                bar.classList.add('show');
                count.textContent = selectedIds.length;
                checkAll.checked = selectedIds.length === allData.length;
            } else {
                bar.classList.remove('show');
            }
        }
        
        // æ˜¾ç¤ºç”Ÿæˆå¼¹çª—
        function showGenerateModal() {
            loadProducts('productSelect');
            document.getElementById('generateModal').classList.add('show');
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQR() {
            const type = document.getElementById('generateType').value;
            const prefix = document.getElementById('prefix').value || 'QR';
            const productId = document.getElementById('productSelect').value;
            const skuId = document.getElementById('skuSelect').value;
            const quantity = document.getElementById('quantity').value;
            
            const formData = new FormData();
            formData.append('prefix', prefix);
            formData.append('create_user', 'admin');
            
            if (productId) {
                formData.append('product_id', productId);
                if (skuId) {
                    formData.append('sku_id', skuId);
                }
            }
            
            if (type === 'batch') {
                formData.append('quantity', quantity);
                fetch('/api/commune/qrcode.php?action=generate_batch', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.msg);
                    if (data.code === 1) {
                        closeModal('generateModal');
                        loadStats();
                        searchQR();
                    }
                });
            } else {
                fetch('/api/commune/qrcode.php?action=generate_single', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.msg);
                    if (data.code === 1) {
                        closeModal('generateModal');
                        loadStats();
                        searchQR();
                    }
                });
            }
        }
        
        // æ˜¾ç¤ºäºŒç»´ç è¯¦æƒ…
        function showQRDetail(id, code) {
            const qrImage = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent('http://bot.gdqshop.cn/scan.html?code=' + code);
            document.getElementById('qrDisplay').innerHTML = `
                <img src="${qrImage}" alt="${code}">
                <div class="code">${code}</div>
            `;
            document.getElementById('qrDetailModal').classList.add('show');
        }
        
        // å…³è”å•†å“
        function linkProduct(id) {
            loadProducts('linkProductSelect');
            window.currentLinkId = id;
            document.getElementById('batchLinkModal').classList.add('show');
        }
        
        // æ‰¹é‡å…³è”
        function batchLink() {
            const ids = selectedIds.join(',');
            const productId = document.getElementById('linkProductSelect').value;
            const skuId = document.getElementById('linkSkuSelect').value;
            
            const formData = new FormData();
            formData.append('ids', ids);
            if (productId) {
                formData.append('product_id', productId);
                if (skuId) {
                    formData.append('sku_id', skuId);
                }
            }
            
            fetch('/api/commune/qrcode.php?action=batch_link', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                alert(data.msg);
                if (data.code === 1) {
                    closeModal('batchLinkModal');
                    selectedIds = [];
                    updateSelectBar();
                    loadQR();
                }
            });
        }
        
        // æ‰¹é‡å…³è”ï¼ˆå•ä¸ªï¼‰
        function linkProduct(id) {
            loadProducts('linkProductSelect');
            window.currentLinkId = id;
            document.getElementById('batchLinkModal').classList.add('show');
            
            // ä¿®æ”¹ç¡®è®¤æŒ‰é’®è¡Œä¸º
            document.querySelector('#batchLinkModal .btn-success').onclick = function() {
                const productId = document.getElementById('linkProductSelect').value;
                const skuId = document.getElementById('linkSkuSelect').value;
                
                fetch('/api/commune/qrcode.php?action=link_product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'id=' + id + '&product_id=' + (productId || 0) + '&sku_id=' + (skuId || 0)
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.msg);
                    if (data.code === 1) {
                        closeModal('batchLinkModal');
                        loadQR();
                    }
                });
            };
        }
        
        // æ˜¾ç¤ºæ‰¹é‡å…³è”å¼¹çª—
        function showBatchLinkModal() {
            if (selectedIds.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©äºŒç»´ç ');
                return;
            }
            loadProducts('linkProductSelect');
            document.getElementById('batchLinkModal').classList.add('show');
            
            // ä¿®æ”¹ç¡®è®¤æŒ‰é’®è¡Œä¸º
            document.querySelector('#batchLinkModal .btn-success').onclick = batchLink;
        }
        
        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œå¼¹çª—
        function showBatchModal() {
            if (selectedIds.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©äºŒç»´ç ');
                return;
            }
            document.getElementById('batchCount').textContent = selectedIds.length;
            document.getElementById('batchModal').classList.add('show');
        }
        
        // æ‰¹é‡åˆ é™¤
        function batchDelete() {
            if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ' + selectedIds.length + ' ä¸ªäºŒç»´ç ï¼Ÿ')) return;
            
            fetch('/api/commune/qrcode.php?action=batch_delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'ids=' + selectedIds.join(',')
            })
            .then(r => r.json())
            .then(data => {
                alert(data.msg);
                if (data.code === 1) {
                    selectedIds = [];
                    updateSelectBar();
                    closeModal('batchModal');
                    loadStats();
                    searchQR();
                }
            });
        }
        
        // åˆ é™¤å•ä¸ª
        function deleteQR(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥äºŒç»´ç ï¼Ÿ')) return;
            
            fetch('/api/commune/qrcode.php?action=delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'id=' + id
            })
            .then(r => r.json())
            .then(data => {
                alert(data.msg);
                if (data.code === 1) {
                    loadStats();
                    searchQR();
                }
            });
        }
        
        // å…³é—­å¼¹çª—
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        // åˆå§‹åŒ–
        loadStats();
        loadQR();
    </script>
</body>
</html>
