<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’‰é’‰ç»‘å®š - æµ·é²œç¤¾</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .icon {
            width: 80px;
            height: 80px;
            background: #07C160;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
        }
        h2 { margin: 0 0 10px; color: #333; }
        p { color: #666; margin: 0 0 20px; }
        .btn {
            background: #07C160;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .btn:disabled { background: #ccc; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="card">
        <div class="icon">ğŸ“±</div>
        <h2>é’‰é’‰ç»‘å®š</h2>
        <p id="status">æ­£åœ¨è·å–ç»‘å®šä¿¡æ¯...</p>
        <button id="bindBtn" class="btn" onclick="doBind()" style="display:none">ç¡®è®¤ç»‘å®š</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        
        if (!userId) {
            document.getElementById('status').innerHTML = '<span class="error">æ— æ•ˆçš„ç»‘å®šé“¾æ¥</span>';
        } else {
            document.getElementById('status').innerHTML = 'ç”¨æˆ·ID: ' + userId + '<br>è¯·åœ¨é’‰é’‰ä¸­æ‰“å¼€æ­¤é¡µé¢å®Œæˆç»‘å®š';
            document.getElementById('bindBtn').style.display = 'block';
        }
        
        function doBind() {
            // è·å–é’‰é’‰ç”¨æˆ·ä¿¡æ¯
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥é€šè¿‡é’‰é’‰SDKè·å–å½“å‰ç”¨æˆ·
            const dingtalkUserId = 'DT_' + Date.now();
            
            // è°ƒç”¨APIç»‘å®š
            fetch('/api/commune/user.php?action=bind_dingtalk', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'user_id=' + userId + '&dingtalk_id=' + dingtalkUserId
            })
            .then(r => r.json())
            .then(data => {
                if (data.code === 1) {
                    document.getElementById('status').innerHTML = '<span class="success">âœ… ç»‘å®šæˆåŠŸï¼</span><br>è¯·å…³é—­æ­¤é¡µé¢';
                    document.getElementById('bindBtn').style.display = 'none';
                } else {
                    document.getElementById('status').innerHTML = '<span class="error">' + data.msg + '</span>';
                }
            })
            .catch(e => {
                document.getElementById('status').innerHTML = '<span class="error">ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•</span>';
            });
        }
    </script>
</body>
</html>
